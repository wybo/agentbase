<!DOCTYPE html>

<html>
<head>
  <title>data.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="data.html">
                data.coffee
              </a>
            
              
              <a class="source" href="fbui.html">
                fbui.coffee
              </a>
            
              
              <a class="source" href="mouse.html">
                mouse.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>data.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>DataSet is an addon for managing data arrays.</p>
<p>DataSets do not need to be the same size as the patch sets. Rather they have
methods for sampling and creating new datasets of any width/height.
They also cam set patch variables resampled to the patch width/height.
Several utilities are provided for creating datasets from Image and
XmlHTTPRequest inputs, and for drawing into the patch drawing layer.</p>
<p>Two specific subclasses are provided for Asc GIS elevation data,
and an image-as-data class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>u = ABM.util
ABM.DataSet = <span class="class"><span class="keyword">class</span> <span class="title">DataSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Static members:</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Create a new dataset using function f on each patch.
If f is string, f set to fcn returning p[f]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@patchDataSet</span>: (f) -&gt; <span class="keyword">new</span> PatchDataSet f</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create a new dataset from an image file name.
Note that datasets can be built in two steps:
An empty constructor which then can be completed by an
async array, Image or XHR response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@importImageDataSet</span>: (name, f=u.pixelByte(<span class="number">0</span>), arrayType=Uint8ClampedArray, rowsPerSlice) -&gt;
    ds = <span class="keyword">new</span> ImageDataSet(<span class="literal">null</span>, f, arrayType, rowsPerSlice) <span class="comment"># empty dataset</span>
    u.importImage name, (img) -&gt; <span class="comment"># =&gt; not needed</span>
      ds.parse img
      f(ds) <span class="keyword">if</span> f?
    ds <span class="comment"># async: ds will be empty until import finishes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Create a new dataset from an Asc GIS file.
The parse method converts a string into a dataset. Async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="property">@importAscDataSet</span>: (name, f) -&gt;
    ds = <span class="keyword">new</span> AscDataSet() <span class="comment"># empty dataset</span>
    u.xhrLoadFile name, <span class="string">"text"</span>, (response) -&gt; <span class="comment"># =&gt; not needed</span>
      ds.parse response <span class="comment"># complete the empty dataset</span>
      f(ds) <span class="keyword">if</span> f?
    ds <span class="comment"># async: ds will be empty until import finishes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>2D Dataset: width/height and an array with length = width*height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (width=<span class="number">0</span>, height=<span class="number">0</span>, data=[]) -&gt; 
    <span class="property">@useNearest</span>=<span class="literal">false</span>
    <span class="property">@reset</span> width, height, data</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Reset a dataset to have new width, height and data.  Allows creating
an empty dataset and having it filled by another function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: (<span class="property">@width</span>, <span class="property">@height</span>, <span class="property">@data</span>) -&gt;
    <span class="keyword">if</span> data.length <span class="keyword">isnt</span> width*height
      u.error <span class="string">"""DataSet: data array length error:
      data.length: <span class="subst">#{@data.length}</span> width: <span class="subst">#{@width}</span> height: <span class="subst">#{@height}</span>
      """</span>
    @</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Check that x,y are valid coords (floats), from top-left of dataset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkXY: (x,y) -&gt;
    u.error <span class="string">"x,y out of range: <span class="subst">#{x}</span>,<span class="subst">#{y}</span>"</span> <span class="keyword">unless</span> (<span class="number">0</span>&lt;=x&lt;=<span class="property">@width</span>-<span class="number">1</span> <span class="keyword">and</span> <span class="number">0</span>&lt;=y&lt;=<span class="property">@height</span>-<span class="number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Sample the dataset.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setSampler: (<span class="property">@useNearest</span>) -&gt;
  sample: (x,y) -&gt; <span class="keyword">if</span> <span class="property">@useNearest</span> <span class="keyword">then</span> <span class="property">@nearest</span> x,y <span class="keyword">else</span> <span class="property">@bilinear</span> x,y</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Sample dataset using nearest neighbor. x,y floats in range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nearest: (x,y) -&gt; <span class="property">@getXY</span> Math.round(x), Math.round(y)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Sample dataset using bilinear (2D) interpolation. x,y floats in range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bilinear: (x,y) -&gt; <span class="comment"># http://en.wikipedia.org/wiki/Bilinear_interpolation</span>
    <span class="property">@checkXY</span> x,y
    x0=Math.floor x; y0=Math.floor y; i=<span class="property">@toIndex</span> x0,y0; w=<span class="property">@width</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Edge case: If x is width-1, x0 is width-1, x is 0, dx is 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    x=x-x0; y=y-y0; dx=<span class="number">1</span>-x; dy=<span class="number">1</span>-y</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Edge case: fij is 0 if beyond data array; undefined -&gt; 0
if fij wrap on x, x is 0, dx is 1; return f00<em>dy+f01</em>y, linear on y</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    f00=<span class="property">@data</span>[i]; f01=<span class="property">@data</span>[i+w] ? <span class="number">0</span>; f10=<span class="property">@data</span>[++i] ? <span class="number">0</span>; f11=<span class="property">@data</span>[i+w] ? <span class="number">0</span>
    f00*dx*dy + f10*x*dy + f01*dx*y + f11*x*y</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Convert x,y ints to index into data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toIndex: (x,y) -&gt; x + y*<span class="property">@width</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Convert int index into data array into x,y ints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toXY: (i) -&gt; [i % <span class="property">@width</span>, Math.floor i/<span class="property">@width</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Get data at x,y int offset into data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getXY: (x,y) -&gt; <span class="property">@checkXY</span> x,y; <span class="property">@data</span>[<span class="property">@toIndex</span> x,y]</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Set the data and int x,y coord of data array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setXY: (x,y,num) -&gt; <span class="property">@checkXY</span> x,y; <span class="property">@data</span>[<span class="property">@toIndex</span> x,y] = num</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Return a printable string for dataset.
If p &lt; 0, print data, otherwise use toFixed to truncate to p precision</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toString: (p=<span class="number">2</span>, sep=<span class="string">", "</span>)-&gt;
    s = <span class="string">"width: <span class="subst">#{@width}</span> height: <span class="subst">#{@height}</span> data:"</span>
    data = <span class="keyword">if</span> p&lt;<span class="number">0</span> <span class="keyword">then</span> <span class="property">@data</span> <span class="keyword">else</span> u.aToFixed <span class="property">@data</span>, p
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@height</span>]
      s += <span class="string">"\n"</span> + <span class="string">"<span class="subst">#{i}</span>: <span class="subst">#{data.slice i*@width, (i+<span class="number">1</span>)*@width}</span>"</span>
    s.replace <span class="regexp">/,/g</span>, sep</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Convert dataset into an image. Normalize data to be allowable image data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toImage: (gray = <span class="literal">true</span>, normalize = <span class="literal">true</span>, alpha = <span class="number">255</span>)-&gt;
    <span class="property">@toContext</span>(gray, normalize, alpha).canvas
  toContext: (gray = <span class="literal">true</span>, normalize = <span class="literal">true</span>, alpha = <span class="number">255</span>)-&gt;
    ctx = u.createCtx <span class="property">@width</span>, <span class="property">@height</span>
    idata = ctx.getImageData(<span class="number">0</span>, <span class="number">0</span>, <span class="property">@width</span>, <span class="property">@height</span>); ta = idata.data
    max = Math.pow(<span class="number">2</span>, <span class="keyword">if</span> gray <span class="keyword">then</span> <span class="number">8</span> <span class="keyword">else</span> <span class="number">24</span>)
    norm = <span class="keyword">if</span> normalize
    <span class="keyword">then</span> u.normalize <span class="property">@data</span>, <span class="number">0</span>, max - <span class="number">0.000001</span>
    <span class="keyword">else</span> (u.clamp Math.round(d), <span class="number">0</span>, max-<span class="number">1</span> <span class="keyword">for</span> d <span class="keyword">in</span> <span class="property">@data</span>)
    <span class="keyword">for</span> num, i <span class="keyword">in</span> norm
      j=<span class="number">4</span>*i; ta[j+<span class="number">3</span>] = alpha
      <span class="keyword">if</span> gray
      <span class="keyword">then</span> ta[j] = ta[j+<span class="number">1</span>] = ta[j+<span class="number">2</span>] = Math.floor num
      <span class="keyword">else</span> ta[j]=num&gt;&gt;&gt;<span class="number">16</span>; ta[j+<span class="number">1</span>]=(num&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>; ta[j+<span class="number">2</span>]=num&amp;<span class="number">0xff</span>
    ctx.putImageData idata, <span class="number">0</span>, <span class="number">0</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Show dataset as image in patch drawing layer or patch colors, return image</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toDrawing: (gray = <span class="literal">true</span>, normalize = <span class="literal">true</span>, alpha = <span class="number">255</span>) -&gt; 
    ABM.patches.installDrawing(img=<span class="property">@toImage</span> gray, normalize, alpha); img
  toPatchColors: (gray = <span class="literal">true</span>, normalize = <span class="literal">true</span>, alpha = <span class="number">255</span>) -&gt; 
    ABM.patches.installColors(img=<span class="property">@toImage</span> gray, normalize, alpha); img</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Resample dataset to patch width/height and set named patch variable.
Note this &quot;insets&quot; the dataset so the variable is sampled the center of the patch.
The dataset can be sampled directly to its edges .. i.e. in agent coords.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toPatchVar: (name) -&gt;
    <span class="keyword">if</span> (ps=ABM.patches).length <span class="keyword">is</span> <span class="property">@data</span>.length
    <span class="keyword">then</span> p[name] = <span class="property">@data</span>[i] <span class="keyword">for</span> p,i <span class="keyword">in</span> ps
    <span class="keyword">else</span> p[name] = <span class="property">@patchSample</span> p.x, p.y <span class="keyword">for</span> p <span class="keyword">in</span> ps
    <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Sample via transformed coords.
x,y is in topleft-bottomright box: [tlx,tly,tlx+w,tly-h]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  coordSample: (x, y, tlx, tly, w, h) -&gt; <span class="comment">#brx, bry) -&gt;</span>
    xs=(x-tlx)*(<span class="property">@width</span>-<span class="number">1</span>)<span class="regexp">/w;  ys=(tly-y)*(@height-1)/</span>h <span class="comment"># convert to sample space</span>
    <span class="property">@sample</span> xs,ys
  patchSample: (px, py) -&gt;
    w=ABM.world
    <span class="property">@coordSample</span> px, py, w.minXcor, w.maxYcor, w.numX, w.numY</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Resample dataset to new width, height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resample: (width, height) -&gt;
    <span class="keyword">return</span> <span class="keyword">new</span> DataSet width,height,<span class="property">@data</span> <span class="keyword">if</span> width <span class="keyword">is</span> <span class="property">@width</span> <span class="keyword">and</span> height <span class="keyword">is</span> <span class="property">@height</span>
    data = []; xScale = (<span class="property">@width</span>-<span class="number">1</span>)<span class="regexp">/(width-1); yScale = (@height-1)/</span>(height-<span class="number">1</span>)
    <span class="keyword">for</span> y <span class="keyword">in</span> [<span class="number">0.</span>..height] <span class="keyword">by</span> <span class="number">1</span>
      <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0.</span>..width] <span class="keyword">by</span> <span class="number">1</span>
        xs=x*xScale; ys=y*yScale
        data.push <span class="property">@sample</span> xs,ys
    <span class="keyword">new</span> DataSet width, height, data</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Return neighbor values of the given x,y of the dataset.
Off-edge neighbors revert to nearest edge value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  neighborhood: (x,y,array=[]) -&gt; <span class="comment"># return 3x3 neighborhood</span>
    array.length = <span class="number">0</span> <span class="comment"># in case user supplied an array</span>
    <span class="keyword">for</span> dy <span class="keyword">in</span> [-<span class="number">1.</span><span class="number">.1</span>]
      <span class="keyword">for</span> dx <span class="keyword">in</span> [-<span class="number">1.</span><span class="number">.1</span>]
        x0=u.clamp x+dx, <span class="number">0</span>, <span class="property">@width</span>-<span class="number">1</span>
        y0=u.clamp y+dy, <span class="number">0</span>, <span class="property">@height</span>-<span class="number">1</span>
        array.push <span class="property">@data</span>[<span class="property">@toIndex</span> x0, y0]
    array</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Return a new dataset of same size convolved with the given kernel 3x3 matrix.
See <a href="http://goo.gl/ubFiji">Convolution article</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  convolve: (kernel,factor=<span class="number">1</span>) -&gt; <span class="comment"># Factory: return new convolved dataset</span>
    array = []; n = []
    <span class="keyword">for</span> y <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@height</span>] <span class="keyword">by</span> <span class="number">1</span>
      <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@width</span>] <span class="keyword">by</span> <span class="number">1</span>
        <span class="property">@neighborhood</span> x,y,n
        array.push u.aSum(u.aPairMul(kernel, n))*factor
    <span class="keyword">new</span> DataSet <span class="property">@width</span>, <span class="property">@height</span>, array</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>A few common convolutions.  dzdx/y are also called horiz/vert Sobel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dzdx: (n=<span class="number">2</span>,factor=<span class="number">1</span>/<span class="number">8</span>) -&gt; <span class="property">@convolve</span>([-<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,-n,<span class="number">0</span>,n,-<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>],factor)
  dzdy: (n=<span class="number">2</span>,factor=<span class="number">1</span>/<span class="number">8</span>) -&gt; <span class="property">@convolve</span>([<span class="number">1</span>,n,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,-<span class="number">1</span>,-n,-<span class="number">1</span>],factor)
  laplace8: () -&gt; <span class="property">@convolve</span>([-<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>,<span class="number">8</span>,-<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>])
  laplace4: () -&gt; <span class="property">@convolve</span>([<span class="number">0</span>,-<span class="number">1</span>,<span class="number">0</span>,-<span class="number">1</span>,<span class="number">4</span>,-<span class="number">1</span>,<span class="number">0</span>,-<span class="number">1</span>,<span class="number">0</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Create two new convolved datasets, slope and aspect, common in
the use of an elevation data set. See Esri tutorials for 
<a href="http://goo.gl/ZcOl08">slope</a> and <a href="http://goo.gl/KoI4y5">aspect</a>
It also returns the two derivitive DataSets, dzdx, dzdy for
those wanting to use the results of the two convolutions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  slopeAndAspect: (noNaNs=<span class="literal">true</span>, posAngle=<span class="literal">true</span>) -&gt; 
    n = <span class="number">2</span>
    dzdx = <span class="property">@dzdx</span>() <span class="comment"># sub left z from right</span>
    dzdy = <span class="property">@dzdy</span>() <span class="comment"># sub bottom z from top</span>
    aspect = []; slope = []
    <span class="keyword">for</span> y <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@height</span>] <span class="keyword">by</span> <span class="number">1</span>
      <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@width</span>] <span class="keyword">by</span> <span class="number">1</span>
        gx = dzdx.getXY(x,y); gy = dzdy.getXY(x,y)
        slope.push Math.atan(Math.sqrt(gx*gx + gy*gy)) <span class="comment">#/(@cellsize)) # radians</span>
        <span class="keyword">while</span> noNaNs <span class="keyword">and</span> gx <span class="keyword">is</span> gy
          gx += u.randomNormal <span class="number">0</span>,<span class="number">.0001</span>; gy += u.randomNormal <span class="number">0</span>,<span class="number">.0001</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>radians in [-PI,PI], downhill</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rad = <span class="keyword">if</span> gx <span class="keyword">is</span> gy <span class="keyword">is</span> <span class="number">0</span> <span class="keyword">then</span> NaN <span class="keyword">else</span> Math.atan2 -gy,-gx</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>positive radians in [0,2PI] if desired</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rad += <span class="number">2</span>*Math.PI <span class="keyword">if</span> posAngle <span class="keyword">and</span> rad &lt; <span class="number">0</span>
        aspect.push rad
    slope = <span class="keyword">new</span> DataSet <span class="property">@width</span>, <span class="property">@height</span>, slope
    aspect = <span class="keyword">new</span> DataSet <span class="property">@width</span>, <span class="property">@height</span>, aspect
    [slope, aspect, dzdx, dzdy]</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Return a subset of the dataset. x,y,width,height integers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  subset: (x, y, width, height) -&gt;
    u.error <span class="string">"subSet: params out of range"</span> <span class="keyword">if</span> x+width&gt;<span class="property">@width</span> <span class="keyword">or</span> y+height&gt;<span class="property">@height</span>
    data = []
    <span class="keyword">for</span> j <span class="keyword">in</span> [y...y+height] <span class="keyword">by</span> <span class="number">1</span>
      <span class="keyword">for</span> i <span class="keyword">in</span> [x...x+width] <span class="keyword">by</span> <span class="number">1</span>
        data.push <span class="property">@getXY</span> i,j
    <span class="keyword">new</span> DataSet width, height, data

ABM.AscDataSet = <span class="class"><span class="keyword">class</span> <span class="title">AscDataSet</span> <span class="keyword">extends</span> <span class="title">DataSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>An .asc GIS file a text file with a header:</p>
<pre><code>ncols 195
nrows 195
xllcorner -84.355652
yllcorner 39.177963
cellsize 0.000093
NODATA_value -9999</code></pre>
<p>..followed by a ncols X nrows matrix of numbers</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Constructor takes a string generally via an xhr request.
It can be &quot;empty&quot; .. i.e. needing a second parse() call
so that it can be used in an async file operation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@str</span>=<span class="string">""</span>) -&gt;
    <span class="keyword">super</span>() <span class="comment"># start out as an empty dataset</span>
    <span class="keyword">return</span> <span class="keyword">if</span> <span class="property">@str</span>.length <span class="keyword">is</span> <span class="number">0</span>
    <span class="property">@parse</span> <span class="property">@str</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Complete an initial, empty dataset object who&#39;s string
is read via an xhr request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parse: (<span class="property">@str</span>) -&gt;
    textData = str.split <span class="string">"\n"</span>; <span class="property">@header</span> = {}; <span class="comment">#gisData.data = []</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span><span class="number">.5</span>]
      keyVal = textData[i].split <span class="regexp">/\s+/</span>
      <span class="property">@header</span>[keyVal[<span class="number">0</span>].toLowerCase()] = parseFloat keyVal[<span class="number">1</span>]
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@header</span>.nrows] <span class="keyword">by</span> <span class="number">1</span>
      nums = textData[<span class="number">6</span>+i].trim().split(<span class="string">" "</span>)
      nums[i] = parseFloat nums[i] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..nums.length]
      <span class="property">@data</span> = <span class="property">@data</span>.concat nums
    <span class="property">@reset</span> <span class="property">@header</span>.ncols, <span class="property">@header</span>.nrows, <span class="property">@data</span>

ABM.ImageDataSet = <span class="class"><span class="keyword">class</span> <span class="title">ImageDataSet</span> <span class="keyword">extends</span> <span class="title">DataSet</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>An image-as-data dataset.  The parser takes an image
data Uint8Array, enumerates it in 4-byte segments converting
the segments into a data element for the given array type.
If rowsPerSlice is set, incrementally traverse image in image
slice of that height; used for huge images.
Defaults to gray scale and Uint8ClampedArray
img may be a canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@img</span>, <span class="property">@f</span>=u.pixelByte(<span class="number">0</span>), <span class="property">@arrayType</span>=Uint8ClampedArray, <span class="property">@rowsPerSlice</span>) -&gt;
    <span class="keyword">super</span>() <span class="comment"># start out as an empty dataset</span>
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@img</span>?
    <span class="property">@parse</span> <span class="property">@img</span>
  parse: (<span class="property">@img</span>) -&gt;
    <span class="property">@rowsPerSlice</span> <span class="keyword">or</span>= <span class="property">@img</span>.height
    data = u.imageRowsToData <span class="property">@img</span>, <span class="property">@rowsPerSlice</span>, <span class="property">@f</span>, <span class="property">@arrayType</span>
    <span class="property">@reset</span> <span class="property">@img</span>.width, <span class="property">@img</span>.height, data
    
ABM.PatchDataSet = <span class="class"><span class="keyword">class</span> <span class="title">PatchDataSet</span> <span class="keyword">extends</span> <span class="title">DataSet</span></span>
  constructor: (f, arrayType=Array) -&gt;
    data = <span class="keyword">new</span> arrayType (ps=ABM.patches).length
    f = u.propFcn f <span class="keyword">if</span> u.isString f
    data[i] = f(p) <span class="keyword">for</span> p,i <span class="keyword">in</span> ps
    <span class="keyword">super</span> ps.numX, ps.numY, data
    <span class="property">@useNearest</span> = <span class="literal">true</span>
  toPatchVar: (name) -&gt;
    p[name] = <span class="property">@data</span>[i] <span class="keyword">for</span> p,i <span class="keyword">in</span> ABM.patches; <span class="literal">null</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
