<!DOCTYPE html>

<html>
<head>
  <title>1-util.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="1-util.html">
                1-util.coffee
              </a>
            
              
              <a class="source" href="2-shapes.html">
                2-shapes.coffee
              </a>
            
              
              <a class="source" href="3-agentset.html">
                3-agentset.coffee
              </a>
            
              
              <a class="source" href="4-agentsets.html">
                4-agentsets.coffee
              </a>
            
              
              <a class="source" href="5-model.html">
                5-model.coffee
              </a>
            
              
              <a class="source" href="6-template.html">
                6-template.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>1-util.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This documentation uses Jeremy Ashkenas&#39;s
<a href="http://jashkenas.github.com/docco/">docco</a> which allows
<a href="http://daringfireball.net/projects/markdown/syntax">markdown</a>.</p>
<p>Create the namespace <strong>ABM</strong> for our project.
Note here <code>this</code> or <code>@</code> == window due to coffeescript wrapper call.
Thus @ABM is placed in the global scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="property">@ABM</span>={}

root = @ <span class="comment"># Keep a private copy of global object</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Global shim for not-yet-standard requestAnimationFrame.
See: <a href="https://gist.github.com/paulirish/1579671">Paul Irish Shim</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">do</span><span class="function"> -&gt;</span> 
  <span class="property">@requestAnimFrame</span> = <span class="property">@requestAnimationFrame</span> <span class="keyword">or</span> <span class="literal">null</span>
  <span class="property">@cancelAnimFrame</span> = <span class="property">@cancelAnimationFrame</span> <span class="keyword">or</span> <span class="literal">null</span>
  <span class="keyword">for</span> vendor <span class="keyword">in</span> [<span class="string">'ms'</span>, <span class="string">'moz'</span>, <span class="string">'webkit'</span>, <span class="string">'o'</span>] <span class="keyword">when</span> <span class="keyword">not</span> <span class="property">@requestAnimFrame</span>
    <span class="property">@requestAnimFrame</span> <span class="keyword">or</span>= @[vendor+<span class="string">'RequestAnimationFrame'</span>]
    <span class="property">@cancelAnimFrame</span> <span class="keyword">or</span>= @[vendor+<span class="string">'CancelAnimationFrame'</span>]
    <span class="property">@cancelAnimFrame</span> <span class="keyword">or</span>= @[vendor+<span class="string">'CancelRequestAnimationFrame'</span>]
  <span class="property">@requestAnimFrame</span> <span class="function"><span class="title">or</span>= <span class="params">(callback)</span> -&gt;</span> <span class="property">@setTimeout</span>(callback, <span class="number">1000</span> / <span class="number">60</span>)
  <span class="property">@cancelAnimFrame</span> <span class="function"><span class="title">or</span>= <span class="params">(id)</span> -&gt;</span> <span class="property">@clearTimeout</span>(id)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Shim for <code>Array.indexOf</code> if not implemented.
Use <a href="https://github.com/kriskowal/es5-shim">es5-shim</a> if additional shims needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="attribute">Array</span>::indexOf <span class="function"><span class="title">or</span>= <span class="params">(item)</span> -&gt;</span> <span class="keyword">return</span> i <span class="keyword">if</span> x <span class="keyword">is</span> item <span class="keyword">for</span> x, i <span class="keyword">in</span> @; -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><strong>ABM.util</strong> contains the general utilities for the project. Note that within
<strong>util</strong> <code>@</code> referrs to ABM.util, <em>not</em> the global name space as above.
Alias: u is an alias for ABM.util within the agentscript module (not outside)</p>
<pre><code> u.clearCtx(ctx) is equivalent to
 ABM.util.clearCtx(ctx)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>ABM.util = u =</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Shortcut for throwing an error.  Good for debugging:</p>
<pre><code>error(&quot;wtf? foo=#{foo}&quot;) if fooProblem</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">error</span>: <span class="function"><span class="params">(s)</span> -&gt;</span> <span class="keyword">throw</span> <span class="keyword">new</span> Error s</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Two max/min int values. One for 2^53, largest int in float64, other for
bitwise ops which are 32 bit. See <a href="http://goo.gl/WpAzT">discussion</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">MaxINT</span>: Math.pow(<span class="number">2</span>,<span class="number">53</span>); <span class="attribute">MinINT</span>: -Math.pow(<span class="number">2</span>,<span class="number">53</span>) <span class="comment"># -@MaxINT fails, @ not defined yet</span>
  <span class="attribute">MaxINT32</span>: <span class="number">0</span>|<span class="number">0x7fffffff</span>; <span class="attribute">MinINT32</span>: <span class="number">0</span>|<span class="number">0x80000000</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Good replacements for Javascript&#39;s badly broken<code>typeof</code> and <code>instanceof</code>
See <a href="http://goo.gl/L0umK">underscore.coffee</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">isArray</span>: Array.isArray <span class="keyword">or</span>
    <span class="function"><span class="params">(obj)</span> -&gt;</span> !!(obj <span class="keyword">and</span> obj.concat <span class="keyword">and</span> obj.unshift <span class="keyword">and</span> <span class="keyword">not</span> obj.callee)
  <span class="attribute">isFunction</span>: <span class="function"><span class="params">(obj)</span> -&gt;</span> 
    !!(obj <span class="keyword">and</span> obj.constructor <span class="keyword">and</span> obj.call <span class="keyword">and</span> obj.apply)
  <span class="attribute">isString</span>: <span class="function"><span class="params">(obj)</span> -&gt;</span> 
    !!(obj <span class="keyword">is</span> <span class="string">''</span> <span class="keyword">or</span> (obj <span class="keyword">and</span> obj.charCodeAt <span class="keyword">and</span> obj.substr))</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="numeric-operations">Numeric Operations</h3>
<p>Replace Math.random with a simple seedable generator.
See <a href="http://goo.gl/FafN3z">StackOverflow</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">randomSeed</span>: <span class="function"><span class="params">(seed=<span class="number">123456</span>)</span> -&gt;</span>
    Math.<span class="function"><span class="title">random</span> = -&gt;</span> x=Math.sin(seed++)*<span class="number">10000</span>; x-Math.floor(x)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Return random int in [0,max) or [min,max)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">randomInt</span>: <span class="function"><span class="params">(max)</span> -&gt;</span> Math.floor(Math.random() * max)
  <span class="attribute">randomInt2</span>: <span class="function"><span class="params">(min, max)</span> -&gt;</span> min + Math.floor(Math.random() * (max-min))</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Return float Gaussian normal with given mean, std deviation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">randomNormal</span>: <span class="function"><span class="params">(mean = <span class="number">0.0</span>, sigma = <span class="number">1.0</span>)</span> -&gt;</span> <span class="comment"># Box-Muller</span>
    u1 = <span class="number">1.0</span>-Math.random(); u2 = Math.random() <span class="comment"># u1 in (0,1]</span>
    norm = Math.sqrt(-<span class="number">2.0</span>*Math.log(u1)) * Math.cos(<span class="number">2.0</span>*Math.PI*u2)
    norm*sigma + mean</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Return float in [0,max) or [min,max) or [-r/2,r/2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">randomFloat</span>: <span class="function"><span class="params">(max)</span> -&gt;</span> Math.random() * max
  <span class="attribute">randomFloat2</span>: <span class="function"><span class="params">(min, max)</span> -&gt;</span> min + Math.random() * (max-min)
  <span class="attribute">randomCentered</span>: <span class="function"><span class="params">(r)</span> -&gt;</span> <span class="property">@randomFloat2</span> -r/<span class="number">2</span>, r/<span class="number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Return log n where base is 10, base, e respectively</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">log10</span>: <span class="function"><span class="params">(n)</span> -&gt;</span> Math.log(n)/Math.LN10
  <span class="attribute">logN</span>: <span class="function"><span class="params">(n, base)</span> -&gt;</span> Math.log(n)/Math.log(base)
  <span class="attribute">ln</span>: <span class="function"><span class="params">(n)</span> -&gt;</span> Math.log n</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Return true <a href="http://goo.gl/spr24">mod functin</a>, % is remainder, not mod.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">mod</span>: <span class="function"><span class="params">(v, n)</span> -&gt;</span> ((v % n) + n) % n</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Return v to be between min, max via mod fcn</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">wrap</span>: <span class="function"><span class="params">(v, min, max)</span> -&gt;</span> min + <span class="property">@mod</span>(v-min, max-min)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return v to be between min, max via clamping with min/max</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">clamp</span>: <span class="function"><span class="params">(v, min, max)</span> -&gt;</span> Math.max(Math.min(v,max),min)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Return sign of a number as +/- 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">sign</span>: <span class="function"><span class="params">(v)</span> -&gt;</span> <span class="keyword">if</span> v&lt;<span class="number">0</span> <span class="keyword">then</span> -<span class="number">1</span> <span class="keyword">else</span> <span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Return n to given precision, default 2
Considerably faster than equivalent: Number(n.toFixed(p))</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">fixed</span>: <span class="function"><span class="params">(n,p=<span class="number">2</span>)</span> -&gt;</span> p = Math.pow(<span class="number">10</span>,p); Math.round(n*p)/p</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Return an array of floating pt numbers as strings at given precision;
useful for printing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">aToFixed</span>: <span class="function"><span class="params">(a, p=<span class="number">2</span>)</span> -&gt;</span> (i.toFixed p <span class="keyword">for</span> i <span class="keyword">in</span> a)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Return localized string for number, with commas etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">tls</span>: <span class="function"><span class="params">(n)</span> -&gt;</span> n.toLocaleString()</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h3 id="color-and-angle-operations">Color and Angle Operations</h3>
<p>Our colors are r,g,b,[a] arrays, with an optional color.str HTML
color string property. The str value is set on the first call to colorStr</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Return a random RGB or gray color. Array passed to minimize garbage collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">randomColor</span>: <span class="function"><span class="params">(c = [])</span> -&gt;</span>
    c.str = <span class="literal">null</span> <span class="keyword">if</span> c.str?
    c[i] = <span class="property">@randomInt</span>(<span class="number">256</span>) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span><span class="number">.2</span>]
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Note: if 2 args passed, assume they&#39;re min, max w/ default c</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">randomGray</span>: <span class="function"><span class="params">(c = [], min = <span class="number">64</span>, max = <span class="number">192</span>)</span> -&gt;</span> 
    <span class="keyword">if</span> arguments.length <span class="keyword">is</span> <span class="number">2</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="property">@randomGray</span> <span class="literal">null</span>, c, min
    c.str = <span class="literal">null</span> <span class="keyword">if</span> c.str?
    r=<span class="property">@randomInt2</span> min,max
    c[i] = r <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span><span class="number">.2</span>]
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Random color from a colormap set of r,g,b values.
Default is one of 125 (5^3) colors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">randomMapColor</span>: <span class="function"><span class="params">(c = [], set = [<span class="number">0</span>,<span class="number">63</span>,<span class="number">127</span>,<span class="number">191</span>,<span class="number">255</span>])</span> -&gt;</span> 
    <span class="property">@setColor</span> c, <span class="property">@oneOf</span>(set), <span class="property">@oneOf</span>(set), <span class="property">@oneOf</span>(set)
  <span class="attribute">randomBrightColor</span>: <span class="function"><span class="params">(c=[])</span> -&gt;</span> <span class="property">@randomMapColor</span> c, [<span class="number">0</span>,<span class="number">127</span>,<span class="number">255</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Modify an existing rgb or gray color.  Alpha optional, not set if not provided.
Modifying an existing array minimizes GC overhead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">setColor</span>: <span class="function"><span class="params">(c, r, g, b, a)</span> -&gt;</span>
    c.str = <span class="literal">null</span> <span class="keyword">if</span> c.str?
    c[<span class="number">0</span>] = r; c[<span class="number">1</span>] = g; c[<span class="number">2</span>] = b; c[<span class="number">3</span>] = a <span class="keyword">if</span> a?
    c
  <span class="attribute">setGray</span>: <span class="function"><span class="params">(c, g, a)</span> -&gt;</span> <span class="property">@setColor</span> c, g, g, g, a</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Return new color, c, by scaling each value of the rgb color max.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">scaleColor</span>: <span class="function"><span class="params">(max, s, c = [])</span> -&gt;</span> 
    c.str = <span class="literal">null</span> <span class="keyword">if</span> c.str?
    c[i] = <span class="property">@clamp</span>(Math.round(val*s),<span class="number">0</span>,<span class="number">255</span>) <span class="keyword">for</span> val, i <span class="keyword">in</span> max <span class="comment"># [r,g,b] must be ints</span>
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Return HTML color as used by canvas element.  Can include Alpha</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">colorStr</span>: <span class="function"><span class="params">(c)</span> -&gt;</span>
    <span class="keyword">return</span> s <span class="keyword">if</span> (s = c.str)?
    <span class="property">@error</span> <span class="string">"alpha &gt; 1"</span> <span class="keyword">if</span> c.length <span class="keyword">is</span> <span class="number">4</span> <span class="keyword">and</span> c[<span class="number">3</span>] &gt; <span class="number">1</span>
    c.str = <span class="keyword">if</span> c.length <span class="keyword">is</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">"rgb(<span class="subst">#{c}</span>)"</span> <span class="keyword">else</span> <span class="string">"rgba(<span class="subst">#{c}</span>)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Compare two colors.  Alas, there is no array.Equal operator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">colorsEqual</span>: <span class="function"><span class="params">(c1, c2)</span> -&gt;</span> c1.toString() <span class="keyword">is</span> c2.toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Convert r,g,b to a luminance float value (not color array).
Round for 0-255 int for gray color value.
<a href="http://goo.gl/pE9cV8">Good post on image filters</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">rgbToGray</span>: <span class="function"><span class="params">(c)</span> -&gt;</span> <span class="number">0.2126</span>*c[<span class="number">0</span>] + <span class="number">0.7152</span>*c[<span class="number">1</span>] + <span class="number">0.0722</span>*c[<span class="number">2</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>RGB &lt;&gt; HSB (HSV) conversions.
RGB in [0-255], HSB in [0-1]
See <a href="http://en.wikipedia.org/wiki/HSV_color_space">Wikipedia</a>
and <a href="http://goo.gl/7yP4cO">Blog Post</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">rgbToHsb</span>: <span class="function"><span class="params">(c)</span> -&gt;</span>
    r=c[<span class="number">0</span>]/<span class="number">255</span>; g=c[<span class="number">1</span>]/<span class="number">255</span>; b=c[<span class="number">2</span>]/<span class="number">255</span>
    max = Math.max(r,g,b); min = Math.min(r,g,b); v = max
    h = <span class="number">0</span>; d = max-min; s = <span class="keyword">if</span> max <span class="keyword">is</span> <span class="number">0</span> <span class="keyword">then</span> <span class="number">0</span> <span class="keyword">else</span> d/max
    <span class="keyword">if</span> max <span class="keyword">isnt</span> min <span class="keyword">then</span> <span class="keyword">switch</span> max
      <span class="keyword">when</span> r <span class="keyword">then</span> h = (g - b) / d + (<span class="keyword">if</span> g &lt; b <span class="keyword">then</span> <span class="number">6</span> <span class="keyword">else</span> <span class="number">0</span>)
      <span class="keyword">when</span> g <span class="keyword">then</span> h = (b - r) / d + <span class="number">2</span>
      <span class="keyword">when</span> b <span class="keyword">then</span> h = (r - g) / d + <span class="number">4</span>
    [Math.round(<span class="number">255</span>*h/<span class="number">6</span>), Math.round(<span class="number">255</span>*s), Math.round(<span class="number">255</span>*v)]
  <span class="attribute">hsbToRgb</span>: <span class="function"><span class="params">(c)</span> -&gt;</span>
    h=c[<span class="number">0</span>]/<span class="number">255</span>; s=c[<span class="number">1</span>]/<span class="number">255</span>; v=c[<span class="number">2</span>]/<span class="number">255</span>; i = Math.floor(h*<span class="number">6</span>)
    f = h * <span class="number">6</span> - i;        p = v * (<span class="number">1</span> - s)
    q = v * (<span class="number">1</span> - f * s);  t = v * (<span class="number">1</span> - (<span class="number">1</span> - f) * s)
    <span class="keyword">switch</span>(i % <span class="number">6</span>)
      <span class="keyword">when</span> <span class="number">0</span> <span class="keyword">then</span> r = v; g = t; b = p
      <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> r = q; g = v; b = p
      <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> r = p; g = v; b = t
      <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> r = p; g = q; b = v
      <span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> r = t; g = p; b = v
      <span class="keyword">when</span> <span class="number">5</span> <span class="keyword">then</span> r = v; g = p; b = q
    [Math.round(r*<span class="number">255</span>), Math.round(g*<span class="number">255</span>), Math.round(b*<span class="number">255</span>)]</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Colormap utilities.  Create an array of colors which are
shared by a set of objects.
Note: Experimental, will change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">rgbMap</span>: <span class="function"><span class="params">(R,G=R,B=R)</span> -&gt;</span>
    R = (Math.round(i*<span class="number">255</span>/(R-<span class="number">1</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..R]) <span class="keyword">if</span> <span class="keyword">typeof</span> R <span class="keyword">is</span> <span class="string">"number"</span>
    G = (Math.round(i*<span class="number">255</span>/(G-<span class="number">1</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..G]) <span class="keyword">if</span> <span class="keyword">typeof</span> G <span class="keyword">is</span> <span class="string">"number"</span>
    B = (Math.round(i*<span class="number">255</span>/(B-<span class="number">1</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..B]) <span class="keyword">if</span> <span class="keyword">typeof</span> B <span class="keyword">is</span> <span class="string">"number"</span>
    map=[]; ((map.push [r,g,b] <span class="keyword">for</span> b <span class="keyword">in</span> B) <span class="keyword">for</span> g <span class="keyword">in</span> G) <span class="keyword">for</span> r <span class="keyword">in</span> R
    map
  <span class="attribute">grayMap</span>:<span class="function"> -&gt;</span> ([i,i,i] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span><span class="number">.255</span>])
  <span class="attribute">hsbMap</span>: <span class="function"><span class="params">(n=<span class="number">256</span>, s=<span class="number">255</span>,b=<span class="number">255</span>)</span>-&gt;</span> 
    (<span class="property">@hsbToRgb</span> [i*<span class="number">255</span>/(n-<span class="number">1</span>),s,b] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..n])
  <span class="attribute">gradientMap</span>: <span class="function"><span class="params">(nColors, stops, locs)</span> -&gt;</span>
    locs = (i/(stops.length-<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..stops.length]) <span class="keyword">if</span> <span class="keyword">not</span> locs?
    ctx = <span class="property">@createCtx</span> nColors, <span class="number">1</span>
    grad = ctx.createLinearGradient <span class="number">0</span>, <span class="number">0</span>, nColors, <span class="number">0</span>
    grad.addColorStop locs[i], <span class="property">@colorStr</span> stops[i] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..stops.length]
    ctx.fillStyle = grad
    ctx.fillRect <span class="number">0</span>, <span class="number">0</span>, nColors, <span class="number">1</span>
    id = <span class="property">@ctxToImageData</span>(ctx).data
    ([id[i], id[i+<span class="number">1</span>], id[i+<span class="number">2</span>]] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..id.length] <span class="keyword">by</span> <span class="number">4</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Return little/big endian-ness of hardware. 
See Mozilla pixel <a href="http://goo.gl/Lxliq">manipulation article</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">isLittleEndian</span>:<span class="function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>convert 1-int array to typed array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d32 = <span class="keyword">new</span> Uint32Array [<span class="number">0x01020304</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>return true if byte order reversed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="keyword">new</span> Uint8ClampedArray d32.buffer)[<span class="number">0</span>] <span class="keyword">is</span> <span class="number">4</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Convert between degrees and radians.  We/Math package use radians.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">degToRad</span>: <span class="function"><span class="params">(degrees)</span> -&gt;</span> degrees * Math.PI / <span class="number">180</span>
  <span class="attribute">radToDeg</span>: <span class="function"><span class="params">(radians)</span> -&gt;</span> radians * <span class="number">180</span> / Math.PI</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Return angle in (-pi,pi] that added to rad2 = rad1
See NetLogo&#39;s <a href="http://goo.gl/CjoHuV">subtract-headings</a> for explanation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">subtractRads</span>: <span class="function"><span class="params">(rad1, rad2)</span> -&gt;</span>
    dr = rad1-rad2; PI = Math.PI
    dr += <span class="number">2</span>*PI <span class="keyword">if</span> dr &lt;= -PI; dr -= <span class="number">2</span>*PI <span class="keyword">if</span> dr &gt; PI; dr</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h3 id="object-operations">Object Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Return object&#39;s own key or variable values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">ownKeys</span>: <span class="function"><span class="params">(obj)</span> -&gt;</span> (key <span class="keyword">for</span> own key, value <span class="keyword">of</span> obj)
  <span class="attribute">ownVarKeys</span>: <span class="function"><span class="params">(obj)</span> -&gt;</span> (key <span class="keyword">for</span> own key, value <span class="keyword">of</span> obj <span class="keyword">when</span> <span class="keyword">not</span> <span class="property">@isFunction</span> value)
  <span class="attribute">ownValues</span>: <span class="function"><span class="params">(obj)</span> -&gt;</span> (value <span class="keyword">for</span> own key, value <span class="keyword">of</span> obj)</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h3 id="array-operations">Array Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Does the array have any elements? Is the array empty?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">any</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> array.length <span class="keyword">isnt</span> <span class="number">0</span>
  <span class="attribute">empty</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> array.length <span class="keyword">is</span> <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Make a copy of the array. Needed when you don&#39;t want to modify the given
array with mutator methods like sort, splice or your own functions.
By giving begin/arguments, retrieve a subset of the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">clone</span>: <span class="function"><span class="params">(array, begin, end)</span> -&gt;</span>
    <span class="keyword">if</span> begin? <span class="keyword">then</span> array.slice begin, end <span class="keyword">else</span> array.slice <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Return last element of array.  Error if empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">last</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> 
    <span class="property">@error</span> <span class="string">"last: empty array"</span> <span class="keyword">if</span> <span class="property">@empty</span> array
    array[array.length-<span class="number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Return random element of array.  Error if empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">oneOf</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> 
    <span class="property">@error</span> <span class="string">"oneOf: empty array"</span> <span class="keyword">if</span> <span class="property">@empty</span> array
    array[<span class="property">@randomInt</span> array.length]</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Return n random elements of array. Error if n &gt; length
Note: array elements presumed unique, i.e. objects or distinct primitives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">nOf</span>: <span class="function"><span class="params">(array, n)</span> -&gt;</span> <span class="comment"># Note: clone, shuffle then first n: poor performance</span>
    n = Math.min(array.length, Math.floor(n)) <span class="comment"># OK if n is float</span>
    r = []; <span class="keyword">while</span> r.length &lt; n
      o = <span class="property">@oneOf</span>(array); r.push o <span class="keyword">unless</span> o <span class="keyword">in</span> r
    r</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>True if item is in array. Binary search if f isnt null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">contains</span>: <span class="function"><span class="params">(array, item, f)</span> -&gt;</span> <span class="property">@indexOf</span>(array, item, f) &gt;= <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Remove an item from an array. Binary search if f isnt null.
Error if item not in array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">removeItem</span>: <span class="function"><span class="params">(array, item, f)</span> -&gt;</span>
    <span class="keyword">unless</span> (i = <span class="property">@indexOf</span> array, item, f) &lt; <span class="number">0</span> <span class="keyword">then</span> array.splice i, <span class="number">1</span> 
    <span class="keyword">else</span> <span class="property">@error</span> <span class="string">"removeItem: item not found"</span> <span class="comment">#; array</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Remove elements in items from an array. Binary search if f isnt null.
Error if an item not in array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">removeItems</span>: <span class="function"><span class="params">(array, items, f)</span> -&gt;</span> <span class="property">@removeItem</span>(array,i,f) <span class="keyword">for</span> i <span class="keyword">in</span> items; array</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Insert an item in a sorted array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">insertItem</span>: <span class="function"><span class="params">(array, item, f)</span> -&gt;</span>
    i = <span class="property">@sortedIndex</span> array, item, f
    error <span class="string">"insertItem: item already in array"</span> <span class="keyword">if</span> array[i] <span class="keyword">is</span> item
    array.splice i, <span class="number">0</span>, item</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Randomize the elements of this array.
Clever! See <a href="http://goo.gl/TT2SY">cookbook</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">shuffle</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> array.sort<span class="function"> -&gt;</span> <span class="number">0.5</span> - Math.random()</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Return o when f(o) min/max in array. Error if array empty.
If f is a string, return element with max value of that property.
If &quot;valueToo&quot; then return a 2-array of the element and the value;
used for cases where f is costly function.</p>
<pre><code>array = [{x:1,y:2}, {x:3,y:4}]
# returns {x: 1, y: 2} 5
[min, dist2] = minOneOf array, ((o)-&gt;o.x*o.x+o.y*o.y), true
# returns {x: 3, y: 4}
max = maxOneOf array, &quot;x&quot;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">minOneOf</span>: <span class="function"><span class="params">(array, f=<span class="property">@identity</span>, valueToo=<span class="literal">false</span>)</span> -&gt;</span>
    <span class="property">@error</span> <span class="string">"minOneOf: empty array"</span> <span class="keyword">if</span> <span class="property">@empty</span> array
    r = Infinity; o = <span class="literal">null</span>; f = <span class="property">@propFcn</span> f <span class="keyword">if</span> <span class="property">@isString</span> f
    <span class="keyword">for</span> a <span class="keyword">in</span> array
      (r = r1; o = a) <span class="keyword">if</span> (r1=f(a)) &lt; r
    <span class="keyword">if</span> valueToo <span class="keyword">then</span> [o, r] <span class="keyword">else</span> o
  <span class="attribute">maxOneOf</span>: <span class="function"><span class="params">(array, f=<span class="property">@identity</span>, valueToo=<span class="literal">false</span>)</span> -&gt;</span>
    <span class="property">@error</span> <span class="string">"maxOneOf: empty array"</span> <span class="keyword">if</span> <span class="property">@empty</span> array
    r = -Infinity; o = <span class="literal">null</span>; f = <span class="property">@propFcn</span> f <span class="keyword">if</span> <span class="property">@isString</span> f
    <span class="keyword">for</span> a <span class="keyword">in</span> array
      (r = r1; o = a) <span class="keyword">if</span> (r1=f(a)) &gt; r
    <span class="keyword">if</span> valueToo <span class="keyword">then</span> [o, r] <span class="keyword">else</span> o
  <span class="attribute">firstOneOf</span>: <span class="function"><span class="params">(array, f)</span> -&gt;</span>
    <span class="keyword">return</span> i <span class="keyword">for</span> a,i <span class="keyword">in</span> array <span class="keyword">when</span> f(a); <span class="keyword">return</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Return histogram of o when f(o) is a numeric value in array.
Histogram interval is bin. Error if array empty.
If f is a string, return histogram of that property.</p>
<p>In examples below, histOf returns [3,1,1,0,0,1]</p>
<pre><code>a = [1,3,4,1,1,10]
h = histOf a, 2, (i) -&gt; i

b = ({id:i} for i in a)
h = histOf b, 2, (o) -&gt; o.id
h = histOf b, 2, &quot;id&quot;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">histOf</span>: <span class="function"><span class="params">(array, bin=<span class="number">1</span>, f=(i)-&gt;i)</span> -&gt;</span>
    r = []; f = <span class="property">@propFcn</span> f <span class="keyword">if</span> <span class="property">@isString</span> f
    <span class="keyword">for</span> a <span class="keyword">in</span> array
      i = Math.floor f(a)/bin
      r[i] = <span class="keyword">if</span> (ri=r[i])? <span class="keyword">then</span> ri+<span class="number">1</span> <span class="keyword">else</span> <span class="number">1</span>
    r[i] = <span class="number">0</span> <span class="keyword">for</span> val,i <span class="keyword">in</span> r <span class="keyword">when</span> <span class="keyword">not</span> val?
    r</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Mutator. Sort array of objects in place by the function f.
If f is string, f returns property of object.
Returns array.
Clone first if you want to preserve the original array.</p>
<pre><code>array = [{i:1},{i:5},{i:-1},{i:2},{i:2}]
sortBy array, &quot;i&quot;
# array now is [{i:-1},{i:1},{i:2},{i:2},{i:5}]</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">sortBy</span>: <span class="function"><span class="params">(array, f)</span> -&gt;</span> 
   f = <span class="property">@propFcn</span> f <span class="keyword">if</span> <span class="property">@isString</span> f <span class="comment"># use item[f] if f is string</span>
   array.sort <span class="function"><span class="params">(a,b)</span> -&gt;</span> f(a) - f(b)</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Mutator. Removes adjacent dups, by reference, in place from sorted array.
Note &quot;by reference&quot; means litteraly same object, not copy. Returns array.
Clone first if you want to preserve the original array.</p>
<pre><code>ids = ({id:i} for i in [0..10])
a = (ids[i] for i in [1,3,4,1,1,10])
# a is [{id:1},{id:3},{id:4},{id:1},{id:1},{id:10}]
b = clone a
sortBy b, &quot;id&quot;
# b is [{id:1},{id:1},{id:1},{id:3},{id:4},{id:10}]
uniq b
# b now is [{id:1},{id:3},{id:4},{id:10}]</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">uniq</span>: <span class="function"><span class="params">(array)</span> -&gt;</span>
    <span class="keyword">return</span> array <span class="keyword">if</span> array.length &lt; <span class="number">2</span> <span class="comment"># return if empty or singlton</span>
    array.splice i,<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> [array.length-<span class="number">1.</span><span class="number">.1</span>] <span class="keyword">by</span> -<span class="number">1</span> <span class="keyword">when</span> array[i-<span class="number">1</span>] <span class="keyword">is</span> array[i]
    array</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Return a new array composed of the rows of a matrix. I.e. convert</p>
<pre><code>[[1,2,3],[4,5,6]] to [1,2,3,4,5,6]</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">flatten</span>: <span class="function"><span class="params">(matrix)</span> -&gt;</span> matrix.reduce<span class="function"><span class="params">( (a,b) -&gt; a.concat b )</span>
  
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Return array of property values of given array of objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">aProp</span>: <span class="function"><span class="params">(array, prop)</span> -&gt;</span> (a[prop] <span class="keyword">for</span> a <span class="keyword">in</span> array)</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Return scalar max/min/sum/avg of numeric array
Iterate rather than reduce: work with typed arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">aMax</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> v=array[<span class="number">0</span>]; v=Math.max v,a <span class="keyword">for</span> a <span class="keyword">in</span> array; v
  <span class="attribute">aMin</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> v=array[<span class="number">0</span>]; v=Math.min v,a <span class="keyword">for</span> a <span class="keyword">in</span> array; v
  <span class="attribute">aSum</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> v=<span class="number">0</span>; v += a <span class="keyword">for</span> a <span class="keyword">in</span> array; v
  <span class="attribute">aAvg</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> <span class="property">@aSum</span>(array)/array.length
  
  <span class="attribute">aNaNs</span>: <span class="function"><span class="params">(array)</span> -&gt;</span> (i <span class="keyword">for</span> v,i <span class="keyword">in</span> array <span class="keyword">when</span> isNaN v)</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Return array composed of f pairwise on both arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">aPairwise</span>: <span class="function"><span class="params">(a1, a2, f)</span> -&gt;</span> v=<span class="number">0</span>; f(v,a2[i]) <span class="keyword">for</span> v,i <span class="keyword">in</span> a1 
  <span class="attribute">aPairSum</span>: <span class="function"><span class="params">(a1, a2)</span> -&gt;</span> <span class="property">@aPairwise</span> a1, a2, <span class="function"><span class="params">(a,b)</span>-&gt;</span>a+b
  <span class="attribute">aPairDif</span>: <span class="function"><span class="params">(a1, a2)</span> -&gt;</span> <span class="property">@aPairwise</span> a1, a2, <span class="function"><span class="params">(a,b)</span>-&gt;</span>a-b
  <span class="attribute">aPairMul</span>: <span class="function"><span class="params">(a1, a2)</span> -&gt;</span> <span class="property">@aPairwise</span> a1, a2, <span class="function"><span class="params">(a,b)</span>-&gt;</span>a*b</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Return a JS array given a TypedArray</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">typedToJS</span>: <span class="function"><span class="params">(typedArray)</span> -&gt;</span> (i <span class="keyword">for</span> i <span class="keyword">in</span> typedArray)</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Return a linear interpolation between lo and hi.
Scale is in [0-1], and the result is in [lo,hi]
<a href="http://goo.gl/QrzMc">Why the name <code>lerp</code>?</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">lerp</span>: <span class="function"><span class="params">(lo, hi, scale)</span> -&gt;</span> lo + (hi-lo)*scale <span class="comment"># @clamp(scale, 0, 1)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Return point interpolated between two points.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">lerp2</span>: <span class="function"><span class="params">(x0, y0, x1, y1, scale)</span> -&gt;</span> [<span class="property">@lerp</span>(x0,x1,scale), <span class="property">@lerp</span>(y0,y1,scale)]</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Return an array with values in [lo,hi], defaults to [0,1].
Note: to have a half-open interval, [lo,hi), try hi=hi-.00009</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">normalize</span>: <span class="function"><span class="params">(array, lo = <span class="number">0</span>, hi = <span class="number">1</span>)</span> -&gt;</span>
    min = <span class="property">@aMin</span> array; max = <span class="property">@aMax</span> array; scale = <span class="number">1</span>/(max-min)
    (<span class="property">@lerp</span>(lo, hi, scale*(num-min)) <span class="keyword">for</span> num <span class="keyword">in</span> array)</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Return array index of item, or index for item if array to remain sorted.
f is used to return an integer for sorting, primarily for object properties.
If f is a string, it is the object property to sort by.
Adapted from underscore&#39;s _.sortedIndex.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">sortedIndex</span>: <span class="function"><span class="params">(array, item, f=(o)-&gt;o)</span> -&gt;</span> <span class="comment"># update to _.sortedIndex someday</span>
    f = <span class="property">@propFcn</span> f <span class="keyword">if</span> <span class="property">@isString</span> f <span class="comment"># use item[f] if f is string</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Why not array.length - 1? Because we can insert 1 after end of array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    value = f(item); low = <span class="number">0</span>; high = array.length
    <span class="keyword">while</span> low &lt; high
      mid = (low + high) &gt;&gt;&gt; <span class="number">1</span> <span class="comment"># floor (low+high)/2</span>
      <span class="keyword">if</span> f(array[mid]) &lt; value <span class="keyword">then</span> low = mid + <span class="number">1</span> <span class="keyword">else</span> high = mid
    low</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Return argument unchanged; for primitive arrays or objs sorted by reference</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">identity</span>: <span class="function"><span class="params">(o)</span> -&gt;</span> o</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Return a function that returns an object&#39;s property.  Property in fcn closure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">propFcn</span>: <span class="function"><span class="params">(prop)</span> -&gt;</span> <span class="function"><span class="params">(o)</span>-&gt;</span>o[prop]</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Return index of value in array or -1 if not found.
If no property given, use Array.indexOf.
If property given, use binary search.
Property can be string or function. If property is &quot;&quot;, use identity default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">indexOf</span>: <span class="function"><span class="params">(array, item, property)</span>-&gt;</span>
    <span class="keyword">if</span> property?
      i = <span class="property">@sortedIndex</span> array, item, <span class="keyword">if</span> property <span class="keyword">is</span> <span class="string">""</span> <span class="keyword">then</span> <span class="literal">null</span> <span class="keyword">else</span> property
      <span class="keyword">if</span> array[i] <span class="keyword">is</span> item <span class="keyword">then</span> i <span class="keyword">else</span> -<span class="number">1</span>
    <span class="keyword">else</span> array.indexOf item</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h3 id="topology-operations">Topology Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Return angle in [-pi,pi] radians from x1,y1 to x2,y2
<a href="http://goo.gl/JS8DF">See: Math.atan2</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">radsToward</span>: <span class="function"><span class="params">(x1, y1, x2, y2)</span> -&gt;</span> Math.atan2 y2-y1, x2-x1</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Return true if x2,y2 is in cone radians around heading radians from x1,x2
and within distance radius from x1,x2.
I.e. is p2 in cone/heading/radius from p1?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">inCone</span>: <span class="function"><span class="params">(heading, cone, radius, x1, y1, x2, y2)</span> -&gt;</span>
    <span class="keyword">if</span> radius &lt; <span class="property">@distance</span> x1, y1, x2, y2 <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">false</span>
    angle12 = <span class="property">@radsToward</span> x1, y1, x2, y2 <span class="comment"># angle from 1 to 2</span>
    cone/<span class="number">2</span> &gt;=Math.abs <span class="property">@subtractRads</span>(heading, angle12)</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Return the Euclidean distance and distance squared between x1,y1, x2,y2.
The squared distance is used for comparisons to avoid the Math.sqrt fcn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">distance</span>: <span class="function"><span class="params">(x1, y1, x2, y2)</span> -&gt;</span> dx = x1-x2; dy = y1-y2; Math.sqrt dx*dx + dy*dy
  <span class="attribute">sqDistance</span>: <span class="function"><span class="params">(x1, y1, x2, y2)</span> -&gt;</span> dx = x1-x2; dy = y1-y2; dx*dx + dy*dy</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Convert polar r,theta to cartesian x,y.
Default to 0,0 origin, optional x,y origin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">polarToXY</span>: <span class="function"><span class="params">(r, theta, x=<span class="number">0</span>, y=<span class="number">0</span>)</span> -&gt;</span> [x+r*Math.cos(theta), y+r*Math.sin(theta)]</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Return the <a href="http://goo.gl/PgJ5N">torus distance</a> and distance squared
between two points A(x1,y1) and B(x2,y2):</p>
<pre><code>dx = |x2-x1|; dy = |y2-y1|
d=sqrt(min(dx, W-dx)^2 + min(dy, H-dy)^2)</code></pre>
<p>Torus note: ABMs often use a Torus topology where the right and left edges
fold to meet,and similarly for the top/bottom.
For points, this is easily handled with the mod function .. insuring the
point is within the rectangle modulo W &amp; H.</p>
<p>The relationship <em>between</em> points is more difficult.  The relationship between
A and B must also include the towards-reflections around A, thus 4 points.</p>
<pre><code>     |               |
     |      W        |
-----+---------------+-----
 B1  |           B   |
     |               |  H
     |               |
     |  A            |
-----+---------------+-----
 B3  |           B2  |
     |               |</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">torusDistance</span>: <span class="function"><span class="params">(x1, y1, x2, y2, w, h)</span> -&gt;</span> 
    Math.sqrt <span class="property">@torusSqDistance</span> x1, y1, x2, y2, w, h
  <span class="attribute">torusSqDistance</span>: <span class="function"><span class="params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    dx = Math.abs x2-x1; dy = Math.abs y2-y1
    dxMin = Math.min dx, w-dx; dyMin = Math.min dy, h-dy
    dxMin*dxMin + dyMin*dyMin</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Return true if closest path between x1,y1 &amp; x2,y2 wraps around the torus.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">torusWraps</span>: <span class="function"><span class="params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    dx = Math.abs x2-x1; dy = Math.abs y2-y1
    dx &gt; w-dx <span class="keyword">or</span> dy &gt; h-dy</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Return 4 torus point reflections of x2,y2 around x1,y1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">torus4Pts</span>: <span class="function"><span class="params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    x2r = <span class="keyword">if</span> x2&lt;x1 <span class="keyword">then</span> x2+w <span class="keyword">else</span> x2-w
    y2r = <span class="keyword">if</span> y2&lt;y1 <span class="keyword">then</span> y2+h <span class="keyword">else</span> y2-h
    [ [x2,y2], [x2r,y2], [x2,y2r], [x2r,y2r] ]</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Return closest of 4 torus pts from A to B</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">torusPt</span>: <span class="function"><span class="params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    x2r = <span class="keyword">if</span> x2&lt;x1 <span class="keyword">then</span> x2+w <span class="keyword">else</span> x2-w
    y2r = <span class="keyword">if</span> y2&lt;y1 <span class="keyword">then</span> y2+h <span class="keyword">else</span> y2-h
    x = <span class="keyword">if</span> Math.abs(x2r-x1) &lt; Math.abs(x2-x1) <span class="keyword">then</span> x2r <span class="keyword">else</span> x2
    y = <span class="keyword">if</span> Math.abs(y2r-y1) &lt; Math.abs(y2-y1) <span class="keyword">then</span> y2r <span class="keyword">else</span> y2
    [x,y]</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Return the angle from x1,y1 to x2.y2 on torus using shortest reflection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">torusRadsToward</span>: <span class="function"><span class="params">(x1, y1, x2, y2, w, h)</span> -&gt;</span> 
    [x2,y2] = <span class="property">@torusPt</span> x1, y1, x2, y2, w, h
    <span class="property">@radsToward</span> x1, y1, x2, y2</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Return true if x2,y2 is in cone radians around heading radians from x1,x2
and within distance radius from x1,x2 considering all torus reflections.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">inTorusCone</span>: <span class="function"><span class="params">(heading, cone, radius, x1, y1, x2, y2, w, h)</span> -&gt;</span>
    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="property">@torus4Pts</span> x1, y1, x2, y2, w, h
      <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">if</span> <span class="property">@inCone</span> heading, cone, radius, x1, y1, p[<span class="number">0</span>], p[<span class="number">1</span>]
    <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <h3 id="file-i-o">File I/O</h3>
<p>Cache of file names used by file imports below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">fileIndex</span>: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Import an image, executing (async) optional function f(img) on completion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">importImage</span>: <span class="function"><span class="params">(name, f = -&gt;)</span> -&gt;</span>
    <span class="keyword">if</span> (img=<span class="property">@fileIndex</span>[name])? <span class="comment"># wtf? or ((img=name).width and img.height)</span>
      f(img) <span class="comment">#if img.isDone</span>
    <span class="keyword">else</span>
      <span class="property">@fileIndex</span>[name] = img = <span class="keyword">new</span> Image()
      img.isDone = <span class="literal">false</span>
      img.<span class="function"><span class="title">onload</span> = -&gt;</span> f(img); img.isDone = <span class="literal">true</span>
      img.src = name
    img</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Use XMLHttpRequest to fetch data of several types. Data Types: text,
arraybuffer, blob, json, document, <a href="http://goo.gl/y3r3h">See specification</a>.
method is &quot;GET&quot; or &quot;POST&quot;. f is function to call onload, default to no-op.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">xhrLoadFile</span>: <span class="function"><span class="params">(name, method=<span class="string">"GET"</span>, type=<span class="string">"text"</span>, f = -&gt;)</span> -&gt;</span> <span class="comment"># AJAX async request</span>
    <span class="keyword">if</span> (xhr=<span class="property">@fileIndex</span>[name])?
      f(xhr.response)
    <span class="keyword">else</span>
      <span class="property">@fileIndex</span>[name] = xhr = <span class="keyword">new</span> XMLHttpRequest()
      xhr.isDone = <span class="literal">false</span>
      xhr.open method, name <span class="comment"># POST mainly for security and large files</span>
      xhr.responseType = type
      xhr.<span class="function"><span class="title">onload</span> = -&gt;</span> f(xhr.response); xhr.isDone = <span class="literal">true</span>
      xhr.send()
    xhr</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Return true if all files are loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">filesLoaded</span>: <span class="function"><span class="params">(files = <span class="property">@fileIndex</span>)</span> -&gt;</span>
    array = (v.isDone <span class="keyword">for</span> v <span class="keyword">in</span> (<span class="property">@ownValues</span> files))
    array.reduce <span class="function"><span class="params">((a,b)-&gt;a <span class="keyword">and</span> b)</span>, <span class="title">true</span>
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Wait for files to be loaded before executing callback f</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">waitOnFiles</span>: <span class="function"><span class="params">(f, files = <span class="property">@fileIndex</span>)</span> -&gt;</span> <span class="property">@waitOn</span> (<span class="function">=&gt;</span> <span class="property">@filesLoaded</span> files), f</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Wait for function done() to return true before calling callback f</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">waitOn</span>: <span class="function"><span class="params">(done, f)</span> -&gt;</span>
    <span class="keyword">if</span> done() <span class="keyword">then</span> f() <span class="keyword">else</span> setTimeout (<span class="function">=&gt;</span> <span class="property">@waitOn</span>(done, f)), <span class="number">1000</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <h3 id="image-data-operations">Image Data Operations</h3>
<p>Make a copy of an image.
Note: new image will have the naturalWidth/Height of input img.
Should be sync</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">cloneImage</span>: <span class="function"><span class="params">(img)</span> -&gt;</span> (i=<span class="keyword">new</span> Image()).src = img.src; i</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Create a data array from an image&#39;s imageData
img may be a canvas.
The function f = f(imageData, rgbIndex) -&gt; number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">imageToData</span>: <span class="function"><span class="params">(img, f=<span class="property">@pixelByte</span>(<span class="number">0</span>), arrayType=Uint8ClampedArray)</span> -&gt;</span>
    <span class="property">@imageRowsToData</span> img, img.height, f, arrayType
  <span class="attribute">imageRowsToData</span>: <span class="function"><span class="params">(img, rowsPerSlice, f=<span class="property">@pixelByte</span>(<span class="number">0</span>), arrayType=Uint8ClampedArray)</span> -&gt;</span>
    rowsDone = <span class="number">0</span>; data = <span class="keyword">new</span> arrayType img.width*img.height
    <span class="keyword">while</span> rowsDone &lt; img.height
      rows = Math.min img.height - rowsDone, rowsPerSlice
      ctx = <span class="property">@imageSliceToCtx</span> img, <span class="number">0</span>, rowsDone, img.width, rows <span class="comment"># REMIND: pass ctx</span>
      idata = <span class="property">@ctxToImageData</span>(ctx).data
      dataStart = rowsDone*img.width
      data[dataStart+i] = f(idata,<span class="number">4</span>*i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..idata.length/<span class="number">4</span>] <span class="keyword">by</span> <span class="number">1</span>
      rowsDone += rows
    data</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Two utilities for Image data extraction.
They return a fcn in a closure which &quot;sees&quot; the args and variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">pixelBytesToInt</span>: <span class="function"><span class="params">(a)</span> -&gt;</span>
    ImageByteFmts = [[<span class="number">2</span>],[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>]]
    a=ImageByteFmts[a-<span class="number">1</span>] <span class="keyword">if</span> <span class="keyword">typeof</span> a <span class="keyword">is</span> <span class="string">"number"</span>
    <span class="function"><span class="params">(id,i)</span>-&gt;</span>val = <span class="number">0</span>; val = val*<span class="number">256</span> + id[i+j] <span class="keyword">for</span> j <span class="keyword">in</span> a; val
  <span class="attribute">pixelByte</span>: <span class="function"><span class="params">(n)</span> -&gt;</span> <span class="function"><span class="params">(id,i)</span>-&gt;</span>id[i+n]</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <h3 id="canvas-context-operations">Canvas/Context Operations</h3>
<p>Create a new canvas of given width/height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">createCanvas</span>: <span class="function"><span class="params">(width, height)</span> -&gt;</span>
    can = document.createElement <span class="string">'canvas'</span>
    can.width = width; can.height = height
    can</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>As above, but returing the context object.
Note ctx.canvas is the canvas for the ctx, and can be use as an image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">createCtx</span>: <span class="function"><span class="params">(width, height, ctxType=<span class="string">"2d"</span>)</span> -&gt;</span>
    can = <span class="property">@createCanvas</span> width, height
    <span class="keyword">if</span> ctxType <span class="keyword">is</span> <span class="string">"2d"</span>
    <span class="keyword">then</span> can.getContext <span class="string">"2d"</span> 
    <span class="keyword">else</span> can.getContext(<span class="string">"webgl"</span>) ? can.getContext(<span class="string">"experimental-webgl"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Return a &quot;layer&quot; 2D/3D rendering context within the specified HTML <code>&lt;div&gt;</code>,
with the given width/height positioned absolutely at top/left within the div,
and with the z-index of z.</p>
<p>The z level gives us the capability of buildng a &quot;stack&quot; of coordinated canvases.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">createLayer</span>: <span class="function"><span class="params">(div, width, height, z, ctx = <span class="string">"2d"</span>)</span> -&gt;</span> <span class="comment"># a canvas ctx object</span>
    <span class="keyword">if</span> ctx <span class="keyword">is</span> <span class="string">"img"</span> 
    <span class="keyword">then</span> element = ctx = <span class="keyword">new</span> Image(); ctx.width = width; ctx.height=height
    <span class="keyword">else</span> element = (ctx=<span class="property">@createCtx</span>(width, height, ctx)).canvas
    <span class="property">@insertLayer</span> div, element, width, height, z
    ctx
  <span class="attribute">insertLayer</span>: <span class="function"><span class="params">(div, element, w, h, z)</span> -&gt;</span>
    element.setAttribute <span class="string">'style'</span>, <span class="comment"># Note: this erases existing style, el.style.position doesnt</span>
    <span class="string">"position:absolute;top:0;left:0;width:<span class="subst">#{w}</span>;height:<span class="subst">#{h}</span>;z-index:<span class="subst">#{z}</span>"</span>
    div.appendChild(element)

  <span class="attribute">setCtxSmoothing</span>: <span class="function"><span class="params">(ctx, smoothing)</span> -&gt;</span>
    ctx.imageSmoothingEnabled = smoothing
    ctx.mozImageSmoothingEnabled = smoothing
    ctx.oImageSmoothingEnabled = smoothing
    ctx.webkitImageSmoothingEnabled = smoothing</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Install identity transform.  Call ctx.restore() to revert to previous transform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">setIdentity</span>: <span class="function"><span class="params">(ctx)</span> -&gt;</span>
    ctx.save() <span class="comment"># revert to native 2D transform</span>
    ctx.setTransform <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Clear the 2D/3D layer to be transparent. Note this <a href="http://goo.gl/qekXS">discussion</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">clearCtx</span>: <span class="function"><span class="params">(ctx)</span> -&gt;</span>
    <span class="keyword">if</span> ctx.save? <span class="comment"># test for 2D ctx</span>
      <span class="property">@setIdentity</span> ctx <span class="comment"># ctx.canvas.width = ctx.canvas.width not used so as to preserve patch coords</span>
      ctx.clearRect <span class="number">0</span>, <span class="number">0</span>, ctx.canvas.width, ctx.canvas.height
      ctx.restore()
    <span class="keyword">else</span> <span class="comment"># 3D</span>
      ctx.clearColor <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> <span class="comment"># transparent!</span>
      ctx.clear ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Fill the 2D/3D layer with the given color</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">fillCtx</span>: <span class="function"><span class="params">(ctx, color)</span> -&gt;</span>
    <span class="keyword">if</span> ctx.fillStyle? <span class="comment"># test for 2D ctx</span>
      <span class="property">@setIdentity</span> ctx
      ctx.fillStyle = <span class="property">@colorStr</span>(color)
      ctx.fillRect <span class="number">0</span>, <span class="number">0</span>, ctx.canvas.width, ctx.canvas.height
      ctx.restore()
    <span class="keyword">else</span> <span class="comment"># 3D</span>
      ctx.clearColor color..., <span class="number">1</span> <span class="comment"># alpha = 1 unless color is rgba</span>
      ctx.clear ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Draw string of the given color at the xy location, in ctx pixel coords.
Use setIdentity .. reset if a transform is being used by caller.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">ctxDrawText</span>: <span class="function"><span class="params">(ctx, string, x, y, color = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>], setIdentity = <span class="literal">true</span>)</span> -&gt;</span>
    <span class="property">@setIdentity</span>(ctx) <span class="keyword">if</span> setIdentity
    ctx.fillStyle = <span class="property">@colorStr</span> color;  ctx.fillText(string, x, y)
    ctx.restore() <span class="keyword">if</span> setIdentity</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Set the element text align and baseline drawing parameters</p>
<ul>
<li>font is a HTML/CSS string like: &quot;9px sans-serif&quot;</li>
<li>align is left right center start end</li>
<li>baseline is top hanging middle alphabetic ideographic bottom</li>
</ul>
<p>See <a href="http://goo.gl/AvEAq">reference</a> for details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">ctxTextParams</span>: <span class="function"><span class="params">(ctx, font, align = <span class="string">"center"</span>, baseline = <span class="string">"middle"</span>)</span> -&gt;</span> 
    ctx.font = font; ctx.textAlign = align; ctx.textBaseline = baseline
  <span class="attribute">elementTextParams</span>: <span class="function"><span class="params">(e, font, align = <span class="string">"center"</span>, baseline = <span class="string">"middle"</span>)</span> -&gt;</span> 
    e = e.canvas <span class="keyword">if</span> e.canvas?
    e.style.font = font; e.style.textAlign = align; e.style.textBaseline = baseline</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Convert an image to a context. ctx.canvas gives the created canvas.
If w, h provided, scale to that size. img may be a canvas
Note: to convert a ctx to an &quot;image&quot; (drawImage) use ctx.canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">imageToCtx</span>: <span class="function"><span class="params">(img, w, h)</span> -&gt;</span>
    <span class="keyword">if</span> w? <span class="keyword">and</span> h?
      ctx = <span class="property">@createCtx</span> w, h
      ctx.drawImage img, <span class="number">0</span>, <span class="number">0</span>, w, h
    <span class="keyword">else</span>
      ctx = <span class="property">@createCtx</span> img.width, img.height
      ctx.drawImage img, <span class="number">0</span>, <span class="number">0</span>
    ctx
  <span class="attribute">imageSliceToCtx</span>: <span class="function"><span class="params">(img, sx, sy, sw, sh, ctx)</span> -&gt;</span>
    <span class="keyword">if</span> ctx?
    <span class="keyword">then</span> ctx.canvas.width = sw; ctx.canvas.height = sh
    <span class="keyword">else</span> ctx = <span class="property">@createCtx</span> sw, sh
    ctx.drawImage img, sx, sy, sw, sh, <span class="number">0</span>, <span class="number">0</span>, sw, sh
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Convert a context to an image, executing function f on completion.
Generally can skip callback but see <a href="http://goo.gl/kIk2U">stackoverflow</a>
Note: uses toDataURL thus possible cross origin problems.
Fix: use ctx.canvas for programatic imaging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">ctxToDataUrl</span>: <span class="function"><span class="params">(ctx)</span> -&gt;</span> ctx.canvas.toDataURL <span class="string">"image/png"</span>
  <span class="attribute">ctxToDataUrlImage</span>: <span class="function"><span class="params">(ctx, f)</span> -&gt;</span>
    img = <span class="keyword">new</span> Image()
    (img.<span class="function"><span class="title">onload</span> = -&gt;</span> f(img)) <span class="keyword">if</span> f?
    img.src = ctx.canvas.toDataURL <span class="string">"image/png"</span>
    img</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Convert a ctx to an imageData object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">ctxToImageData</span>: <span class="function"><span class="params">(ctx)</span> -&gt;</span>
    ctx.getImageData <span class="number">0</span>, <span class="number">0</span>, ctx.canvas.width, ctx.canvas.height</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Canvas versions of above
canvasToImage: (canvas) -&gt; ctxToImage(canvas.getContext &quot;2d&quot;)
canvasToImageData: (canvas) -&gt; ctxToImageData(canvas.getContext &quot;2d&quot;)
imageToCanvas: (image) -&gt; imageToCtx(image).canvas</p>

            </div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Draw an image centered at x, y w/ image size dx, dy.
See <a href="http://goo.gl/VUlhY">this tutorial</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">drawCenteredImage</span>: <span class="function"><span class="params">(ctx, img, rad, x, y, dx, dy)</span> -&gt;</span> <span class="comment"># presume save/restore surrounds this</span>
    ctx.translate x, y <span class="comment"># translate to center</span>
    ctx.rotate rad
    ctx.drawImage img, -dx/<span class="number">2</span>, -dy/<span class="number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Duplicate a ctx&#39;s image.  Returns the new ctx, use ctx.canvas for canvas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">copyCtx</span>: <span class="function"><span class="params">(ctx0)</span> -&gt;</span>
    ctx = <span class="property">@createCtx</span> ctx0.canvas.width, ctx0.canvas.height
    ctx.drawImage ctx0.canvas, <span class="number">0</span>, <span class="number">0</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Resize a ctx/canvas and preserve data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">resizeCtx</span>: <span class="function"><span class="params">(ctx, width, height, scale = <span class="literal">false</span>)</span> -&gt;</span> <span class="comment"># http://goo.gl/Tp90B</span>
    copy = <span class="property">@copyCtx</span> ctx
    ctx.canvas.width = width; ctx.canvas.height = height
    ctx.drawImage copy.canvas, <span class="number">0</span>, <span class="number">0</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
