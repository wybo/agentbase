<!DOCTYPE html>

<html>
<head>
  <title>util.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>util.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This documentation uses Jeremy Ashkenas’s
<a href="http://jashkenas.github.com/docco/">docco</a> which allows
<a href="http://daringfireball.net/projects/markdown/syntax">markdown</a>.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Create the namespace <strong>ABM</strong> for our project.
Note here <code>this</code> or <code>@</code> == window due to coffeescript wrapper call.
Thus @ABM is placed in the global scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-property">@ABM</span>={}

root = @ <span class="hljs-comment"># Keep a private copy of global object</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Global shim for not-yet-standard requestAnimationFrame.
See: <a href="https://gist.github.com/paulirish/1579671">Paul Irish Shim</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">do</span><span class="hljs-function"> -&gt;</span> 
  <span class="hljs-property">@requestAnimFrame</span> = <span class="hljs-property">@requestAnimationFrame</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>
  <span class="hljs-property">@cancelAnimFrame</span> = <span class="hljs-property">@cancelAnimationFrame</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>
  <span class="hljs-keyword">for</span> vendor <span class="hljs-keyword">in</span> [<span class="hljs-string">'ms'</span>, <span class="hljs-string">'moz'</span>, <span class="hljs-string">'webkit'</span>, <span class="hljs-string">'o'</span>] <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@requestAnimFrame</span>
    <span class="hljs-property">@requestAnimFrame</span> <span class="hljs-keyword">or</span>= @[vendor+<span class="hljs-string">'RequestAnimationFrame'</span>]
    <span class="hljs-property">@cancelAnimFrame</span> <span class="hljs-keyword">or</span>= @[vendor+<span class="hljs-string">'CancelAnimationFrame'</span>]
    <span class="hljs-property">@cancelAnimFrame</span> <span class="hljs-keyword">or</span>= @[vendor+<span class="hljs-string">'CancelRequestAnimationFrame'</span>]
  <span class="hljs-property">@requestAnimFrame</span> <span class="hljs-function"><span class="hljs-title">or</span>= <span class="hljs-params">(callback)</span> -&gt;</span> <span class="hljs-property">@setTimeout</span>(callback, <span class="hljs-number">1000</span> / <span class="hljs-number">60</span>)
  <span class="hljs-property">@cancelAnimFrame</span> <span class="hljs-function"><span class="hljs-title">or</span>= <span class="hljs-params">(id)</span> -&gt;</span> <span class="hljs-property">@clearTimeout</span>(id)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Shim for <code>Array.indexOf</code> if not implemented.
Use <a href="https://github.com/kriskowal/es5-shim">es5-shim</a> if additional shims needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Array</span>::indexOf <span class="hljs-function"><span class="hljs-title">or</span>= <span class="hljs-params">(item)</span> -&gt;</span> <span class="hljs-keyword">return</span> i <span class="hljs-keyword">if</span> x <span class="hljs-keyword">is</span> item <span class="hljs-keyword">for</span> x, i <span class="hljs-keyword">in</span> @; -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>ABM.util</strong> contains the general utilities for the project. Note that within
<strong>util</strong> <code>@</code> referrs to ABM.util, <em>not</em> the global name space as above.
Alias: u is an alias for ABM.util within the agentscript module (not outside)</p>
<pre><code> u.clearCtx(ctx) <span class="hljs-keyword">is</span> equivalent to
 ABM.util.clearCtx(ctx)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
ABM.util = u =</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Shortcut for throwing an error.  Good for debugging:</p>
<pre><code>error(<span class="hljs-string">"wtf? foo=<span class="hljs-subst">#{foo}</span>"</span>) <span class="hljs-keyword">if</span> fooProblem
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">error</span>: <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error s</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Two max/min int values. One for 2^53, largest int in float64, other for
bitwise ops which are 32 bit. See <a href="http://goo.gl/WpAzT">discussion</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">MaxINT</span>: Math.pow(<span class="hljs-number">2</span>,<span class="hljs-number">53</span>); <span class="hljs-attribute">MinINT</span>: -Math.pow(<span class="hljs-number">2</span>,<span class="hljs-number">53</span>) <span class="hljs-comment"># -@MaxINT fails, @ not defined yet</span>
  <span class="hljs-attribute">MaxINT32</span>: <span class="hljs-number">0</span>|<span class="hljs-number">0x7fffffff</span>; <span class="hljs-attribute">MinINT32</span>: <span class="hljs-number">0</span>|<span class="hljs-number">0x80000000</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Good replacements for Javascript’s badly broken<code>typeof</code> and <code>instanceof</code>
See <a href="http://goo.gl/L0umK">underscore.coffee</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isArray</span>: Array.isArray <span class="hljs-keyword">or</span>
    <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> !!(obj <span class="hljs-keyword">and</span> obj.concat <span class="hljs-keyword">and</span> obj.unshift <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> obj.callee)
  <span class="hljs-attribute">isFunction</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> 
    !!(obj <span class="hljs-keyword">and</span> obj.constructor <span class="hljs-keyword">and</span> obj.call <span class="hljs-keyword">and</span> obj.apply)
  <span class="hljs-attribute">isString</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> 
    !!(obj <span class="hljs-keyword">is</span> <span class="hljs-string">''</span> <span class="hljs-keyword">or</span> (obj <span class="hljs-keyword">and</span> obj.charCodeAt <span class="hljs-keyword">and</span> obj.substr))</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3 id="numeric-operations">Numeric Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Replace Math.random with a simple seedable generator.
See <a href="http://goo.gl/FafN3z">StackOverflow</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomSeed</span>: <span class="hljs-function"><span class="hljs-params">(seed=<span class="hljs-number">123456</span>)</span> -&gt;</span>
    Math.<span class="hljs-function"><span class="hljs-title">random</span> = -&gt;</span> x=Math.sin(seed++)*<span class="hljs-number">10000</span>; x-Math.floor(x)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Return random int in [0,max) or [min,max)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomInt</span>: <span class="hljs-function"><span class="hljs-params">(max)</span> -&gt;</span> Math.floor(Math.random() * max)
  <span class="hljs-attribute">randomInt2</span>: <span class="hljs-function"><span class="hljs-params">(min, max)</span> -&gt;</span> min + Math.floor(Math.random() * (max-min))</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Return float Gaussian normal with given mean, std deviation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomNormal</span>: <span class="hljs-function"><span class="hljs-params">(mean = <span class="hljs-number">0.0</span>, sigma = <span class="hljs-number">1.0</span>)</span> -&gt;</span> <span class="hljs-comment"># Box-Muller</span>
    u1 = <span class="hljs-number">1.0</span>-Math.random(); u2 = Math.random() <span class="hljs-comment"># u1 in (0,1]</span>
    norm = Math.sqrt(-<span class="hljs-number">2.0</span>*Math.log(u1)) * Math.cos(<span class="hljs-number">2.0</span>*Math.PI*u2)
    norm*sigma + mean</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Return float in [0,max) or [min,max) or [-r/2,r/2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomFloat</span>: <span class="hljs-function"><span class="hljs-params">(max)</span> -&gt;</span> Math.random() * max
  <span class="hljs-attribute">randomFloat2</span>: <span class="hljs-function"><span class="hljs-params">(min, max)</span> -&gt;</span> min + Math.random() * (max-min)
  <span class="hljs-attribute">randomCentered</span>: <span class="hljs-function"><span class="hljs-params">(r)</span> -&gt;</span> <span class="hljs-property">@randomFloat2</span> -r/<span class="hljs-number">2</span>, r/<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Return log n where base is 10, base, e respectively.
Note ln: (n) -&gt; Math.log n .. i.e. JS’s log is log base e</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">log10</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span> Math.log(n)/Math.LN10
  <span class="hljs-attribute">log2</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span> <span class="hljs-property">@logN</span> n, <span class="hljs-number">2</span>
  <span class="hljs-attribute">logN</span>: <span class="hljs-function"><span class="hljs-params">(n, base)</span> -&gt;</span> Math.log(n)/Math.log(base)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return true <a href="http://goo.gl/spr24">mod functin</a>, % is remainder, not mod.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">mod</span>: <span class="hljs-function"><span class="hljs-params">(v, n)</span> -&gt;</span> ((v % n) + n) % n</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Return v to be between min, max via mod fcn</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">wrap</span>: <span class="hljs-function"><span class="hljs-params">(v, min, max)</span> -&gt;</span> min + <span class="hljs-property">@mod</span>(v-min, max-min)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Return v to be between min, max via clamping with min/max</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clamp</span>: <span class="hljs-function"><span class="hljs-params">(v, min, max)</span> -&gt;</span> Math.max(Math.min(v,max),min)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Return sign of a number as +/- 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sign</span>: <span class="hljs-function"><span class="hljs-params">(v)</span> -&gt;</span> <span class="hljs-keyword">if</span> v&lt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Return n to given precision, default 2
Considerably faster than equivalent: Number(n.toFixed(p))</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fixed</span>: <span class="hljs-function"><span class="hljs-params">(n,p=<span class="hljs-number">2</span>)</span> -&gt;</span> p = Math.pow(<span class="hljs-number">10</span>,p); Math.round(n*p)/p</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Return an array of floating pt numbers as strings at given precision;
useful for printing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aToFixed</span>: <span class="hljs-function"><span class="hljs-params">(a, p=<span class="hljs-number">2</span>)</span> -&gt;</span> (i.toFixed p <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a)</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Return localized string for number, with commas etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">tls</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span> n.toLocaleString()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3 id="color-and-angle-operations">Color and Angle Operations</h3>
<p>Our colors are r,g,b,[a] arrays, with an optional color.str HTML
color string property. The str value is set on the first call to colorStr</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Return a random RGB or gray color. Array passed to minimize garbage collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomColor</span>: <span class="hljs-function"><span class="hljs-params">(c = [])</span> -&gt;</span>
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    c[i] = <span class="hljs-property">@randomInt</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.2</span>]
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Note: if 2 args passed, assume they’re min, max w/ default c</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomGray</span>: <span class="hljs-function"><span class="hljs-params">(c = [], min = <span class="hljs-number">64</span>, max = <span class="hljs-number">192</span>)</span> -&gt;</span> 
    <span class="hljs-keyword">if</span> arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-property">@randomGray</span> <span class="hljs-literal">null</span>, c, min
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    r=<span class="hljs-property">@randomInt2</span> min,max
    c[i] = r <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.2</span>]
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Random color from a colormap set of r,g,b values.
Default is one of 125 (5^3) colors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">randomMapColor</span>: <span class="hljs-function"><span class="hljs-params">(c = [], set = [<span class="hljs-number">0</span>,<span class="hljs-number">63</span>,<span class="hljs-number">127</span>,<span class="hljs-number">191</span>,<span class="hljs-number">255</span>])</span> -&gt;</span> 
    <span class="hljs-property">@setColor</span> c, <span class="hljs-property">@oneOf</span>(set), <span class="hljs-property">@oneOf</span>(set), <span class="hljs-property">@oneOf</span>(set)
  <span class="hljs-attribute">randomBrightColor</span>: <span class="hljs-function"><span class="hljs-params">(c=[])</span> -&gt;</span> <span class="hljs-property">@randomMapColor</span> c, [<span class="hljs-number">0</span>,<span class="hljs-number">127</span>,<span class="hljs-number">255</span>]
  <span class="hljs-attribute">randomHSBColor</span>: <span class="hljs-function"><span class="hljs-params">(c=[])</span> -&gt;</span>
    c = <span class="hljs-property">@hsbToRgb</span>([<span class="hljs-property">@randomInt</span>(<span class="hljs-number">51</span>)*<span class="hljs-number">5</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Modify an existing rgb or gray color.  Alpha optional, not set if not provided.
Modifying an existing array minimizes GC overhead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setColor</span>: <span class="hljs-function"><span class="hljs-params">(c, r, g, b, a)</span> -&gt;</span>
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    c[<span class="hljs-number">0</span>] = r; c[<span class="hljs-number">1</span>] = g; c[<span class="hljs-number">2</span>] = b; c[<span class="hljs-number">3</span>] = a <span class="hljs-keyword">if</span> a?
    c
  <span class="hljs-attribute">setGray</span>: <span class="hljs-function"><span class="hljs-params">(c, g, a)</span> -&gt;</span> <span class="hljs-property">@setColor</span> c, g, g, g, a</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Return new color, c, by scaling each value of the rgb color max.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">scaleColor</span>: <span class="hljs-function"><span class="hljs-params">(max, s, c = [])</span> -&gt;</span> 
    c.str = <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> c.str?
    c[i] = <span class="hljs-property">@clamp</span>(Math.round(val*s),<span class="hljs-number">0</span>,<span class="hljs-number">255</span>) <span class="hljs-keyword">for</span> val, i <span class="hljs-keyword">in</span> max <span class="hljs-comment"># [r,g,b] must be ints</span>
    c</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return HTML color as used by canvas element.  Can include Alpha</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">colorStr</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> s <span class="hljs-keyword">if</span> (s = c.str)?
    <span class="hljs-property">@error</span> <span class="hljs-string">"alpha &gt; 1"</span> <span class="hljs-keyword">if</span> c.length <span class="hljs-keyword">is</span> <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> c[<span class="hljs-number">3</span>] &gt; <span class="hljs-number">1</span>
    c.str = <span class="hljs-keyword">if</span> c.length <span class="hljs-keyword">is</span> <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"rgb(<span class="hljs-subst">#{c}</span>)"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"rgba(<span class="hljs-subst">#{c}</span>)"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Compare two colors.  Alas, there is no array.Equal operator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">colorsEqual</span>: <span class="hljs-function"><span class="hljs-params">(c1, c2)</span> -&gt;</span> c1.toString() <span class="hljs-keyword">is</span> c2.toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Convert r,g,b to a luminance float value (not color array).
Round for 0-255 int for gray color value.
<a href="http://goo.gl/pE9cV8">Good post on image filters</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rgbToGray</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span> <span class="hljs-number">0.2126</span>*c[<span class="hljs-number">0</span>] + <span class="hljs-number">0.7152</span>*c[<span class="hljs-number">1</span>] + <span class="hljs-number">0.0722</span>*c[<span class="hljs-number">2</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>RGB &lt;&gt; HSB (HSV) conversions.
RGB in [0-255], HSB in [0-1]
See <a href="http://en.wikipedia.org/wiki/HSV_color_space">Wikipedia</a>
and <a href="http://goo.gl/7yP4cO">Blog Post</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rgbToHsb</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span>
    r=c[<span class="hljs-number">0</span>]/<span class="hljs-number">255</span>; g=c[<span class="hljs-number">1</span>]/<span class="hljs-number">255</span>; b=c[<span class="hljs-number">2</span>]/<span class="hljs-number">255</span>
    max = Math.max(r,g,b); min = Math.min(r,g,b); v = max
    h = <span class="hljs-number">0</span>; d = max-min; s = <span class="hljs-keyword">if</span> max <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> d/max
    <span class="hljs-keyword">if</span> max <span class="hljs-keyword">isnt</span> min <span class="hljs-keyword">then</span> <span class="hljs-keyword">switch</span> max
      <span class="hljs-keyword">when</span> r <span class="hljs-keyword">then</span> h = (g - b) / d + (<span class="hljs-keyword">if</span> g &lt; b <span class="hljs-keyword">then</span> <span class="hljs-number">6</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>)
      <span class="hljs-keyword">when</span> g <span class="hljs-keyword">then</span> h = (b - r) / d + <span class="hljs-number">2</span>
      <span class="hljs-keyword">when</span> b <span class="hljs-keyword">then</span> h = (r - g) / d + <span class="hljs-number">4</span>
    [Math.round(<span class="hljs-number">255</span>*h/<span class="hljs-number">6</span>), Math.round(<span class="hljs-number">255</span>*s), Math.round(<span class="hljs-number">255</span>*v)]
  <span class="hljs-attribute">hsbToRgb</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span>
    h=c[<span class="hljs-number">0</span>]/<span class="hljs-number">255</span>; s=c[<span class="hljs-number">1</span>]/<span class="hljs-number">255</span>; v=c[<span class="hljs-number">2</span>]/<span class="hljs-number">255</span>; i = Math.floor(h*<span class="hljs-number">6</span>)
    f = h * <span class="hljs-number">6</span> - i;        p = v * (<span class="hljs-number">1</span> - s)
    q = v * (<span class="hljs-number">1</span> - f * s);  t = v * (<span class="hljs-number">1</span> - (<span class="hljs-number">1</span> - f) * s)
    <span class="hljs-keyword">switch</span>(i % <span class="hljs-number">6</span>)
      <span class="hljs-keyword">when</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> r = v; g = t; b = p
      <span class="hljs-keyword">when</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> r = q; g = v; b = p
      <span class="hljs-keyword">when</span> <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> r = p; g = v; b = t
      <span class="hljs-keyword">when</span> <span class="hljs-number">3</span> <span class="hljs-keyword">then</span> r = p; g = q; b = v
      <span class="hljs-keyword">when</span> <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> r = t; g = p; b = v
      <span class="hljs-keyword">when</span> <span class="hljs-number">5</span> <span class="hljs-keyword">then</span> r = v; g = p; b = q
    [Math.round(r*<span class="hljs-number">255</span>), Math.round(g*<span class="hljs-number">255</span>), Math.round(b*<span class="hljs-number">255</span>)]</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Colormap utilities.  Create an array of colors which are
shared by a set of objects.
Note: Experimental, will change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rgbMap</span>: <span class="hljs-function"><span class="hljs-params">(R,G=R,B=R)</span> -&gt;</span>
    R = (Math.round(i*<span class="hljs-number">255</span>/(R-<span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..R]) <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> R <span class="hljs-keyword">is</span> <span class="hljs-string">"number"</span>
    G = (Math.round(i*<span class="hljs-number">255</span>/(G-<span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..G]) <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> G <span class="hljs-keyword">is</span> <span class="hljs-string">"number"</span>
    B = (Math.round(i*<span class="hljs-number">255</span>/(B-<span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..B]) <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> B <span class="hljs-keyword">is</span> <span class="hljs-string">"number"</span>
    map=[]; ((map.push [r,g,b] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> B) <span class="hljs-keyword">for</span> g <span class="hljs-keyword">in</span> G) <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> R
    map
  <span class="hljs-attribute">grayMap</span>:<span class="hljs-function"> -&gt;</span> ([i,i,i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.255</span>])
  <span class="hljs-attribute">hsbMap</span>: <span class="hljs-function"><span class="hljs-params">(n=<span class="hljs-number">256</span>, s=<span class="hljs-number">255</span>,b=<span class="hljs-number">255</span>)</span>-&gt;</span> 
    (<span class="hljs-property">@hsbToRgb</span> [i*<span class="hljs-number">255</span>/(n-<span class="hljs-number">1</span>),s,b] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..n])
  <span class="hljs-attribute">gradientMap</span>: <span class="hljs-function"><span class="hljs-params">(nColors, stops, locs)</span> -&gt;</span>
    locs = (i/(stops.length-<span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..stops.length]) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> locs?
    ctx = <span class="hljs-property">@createCtx</span> nColors, <span class="hljs-number">1</span>
    grad = ctx.createLinearGradient <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, nColors, <span class="hljs-number">0</span>
    grad.addColorStop locs[i], <span class="hljs-property">@colorStr</span> stops[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..stops.length]
    ctx.fillStyle = grad
    ctx.fillRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, nColors, <span class="hljs-number">1</span>
    id = <span class="hljs-property">@ctxToImageData</span>(ctx).data
    ([id[i], id[i+<span class="hljs-number">1</span>], id[i+<span class="hljs-number">2</span>]] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..id.length] <span class="hljs-keyword">by</span> <span class="hljs-number">4</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Return little/big endian-ness of hardware. 
See Mozilla pixel <a href="http://goo.gl/Lxliq">manipulation article</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">isLittleEndian</span>:<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>convert 1-int array to typed array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d32 = <span class="hljs-keyword">new</span> Uint32Array [<span class="hljs-number">0x01020304</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>return true if byte order reversed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-keyword">new</span> Uint8ClampedArray d32.buffer)[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-number">4</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Convert between degrees and radians.  We/Math package use radians.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">degToRad</span>: <span class="hljs-function"><span class="hljs-params">(degrees)</span> -&gt;</span> degrees * Math.PI / <span class="hljs-number">180</span>
  <span class="hljs-attribute">radToDeg</span>: <span class="hljs-function"><span class="hljs-params">(radians)</span> -&gt;</span> radians * <span class="hljs-number">180</span> / Math.PI</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Return angle in (-pi,pi] that added to rad2 = rad1
See NetLogo’s <a href="http://goo.gl/CjoHuV">subtract-headings</a> for explanation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">subtractRads</span>: <span class="hljs-function"><span class="hljs-params">(rad1, rad2)</span> -&gt;</span>
    dr = rad1-rad2; PI = Math.PI
    dr += <span class="hljs-number">2</span>*PI <span class="hljs-keyword">if</span> dr &lt;= -PI; dr -= <span class="hljs-number">2</span>*PI <span class="hljs-keyword">if</span> dr &gt; PI; dr</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h3 id="object-operations">Object Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Return object’s own key or variable values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ownKeys</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> (key <span class="hljs-keyword">for</span> own key, value <span class="hljs-keyword">of</span> obj)
  <span class="hljs-attribute">ownVarKeys</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> (key <span class="hljs-keyword">for</span> own key, value <span class="hljs-keyword">of</span> obj <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@isFunction</span> value)
  <span class="hljs-attribute">ownValues</span>: <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> (value <span class="hljs-keyword">for</span> own key, value <span class="hljs-keyword">of</span> obj)</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Parse a string to its JS value.
If s isn’t a JS expression, return decoded string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">parseToPrimitive</span>: <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> <span class="hljs-comment"># http://goo.gl/jxb6Ae http://goo.gl/mQsQan</span>
    <span class="hljs-keyword">try</span> JSON.parse(s); <span class="hljs-keyword">catch</span> e <span class="hljs-keyword">then</span> decodeURIComponent(s)</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Return URL queryString as object, defaulting to this page’s.
If query element has no “=”, set value to true.
Otherwise use parseToPrimitive. <a href="http://goo.gl/vIwdG6">StackOverflow</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">parseQueryString</span>: <span class="hljs-function"><span class="hljs-params">(query = <span class="hljs-built_in">window</span>.location.search.substring(<span class="hljs-number">1</span>))</span> -&gt;</span>
    res = {}
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> query.split <span class="hljs-string">"&amp;"</span> <span class="hljs-keyword">when</span> query.length <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span>
      t=s.split <span class="hljs-string">"="</span>
      res[t[<span class="hljs-number">0</span>]]=<span class="hljs-keyword">if</span> t.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-property">@parseToPrimitive</span>(t[<span class="hljs-number">1</span>])
    res</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h3 id="array-operations">Array Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Does the array have any elements? Is the array empty?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">any</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.length <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span>
  <span class="hljs-attribute">empty</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Make a copy of the array. Needed when you don’t want to modify the given
array with mutator methods like sort, splice or your own functions.
By giving begin/arguments, retrieve a subset of the array.
Works with TypedArrays too.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clone</span>: <span class="hljs-function"><span class="hljs-params">(array, begin, end)</span> -&gt;</span>
    op = <span class="hljs-keyword">if</span> array.slice? <span class="hljs-keyword">then</span> <span class="hljs-string">"slice"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"subarray"</span>
    <span class="hljs-keyword">if</span> begin? <span class="hljs-keyword">then</span> array[op] begin, end <span class="hljs-keyword">else</span> array[op] <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Return last element of array.  Error if empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">last</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> 
    <span class="hljs-property">@error</span> <span class="hljs-string">"last: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    array[array.length-<span class="hljs-number">1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Return random element of array.  Error if empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">oneOf</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> 
    <span class="hljs-property">@error</span> <span class="hljs-string">"oneOf: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    array[<span class="hljs-property">@randomInt</span> array.length]</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Return n random elements of array. Error if n &gt; length
Note: array elements presumed unique, i.e. objects or distinct primitives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">nOf</span>: <span class="hljs-function"><span class="hljs-params">(array, n)</span> -&gt;</span> <span class="hljs-comment"># Note: clone, shuffle then first n: poor performance</span>
    n = Math.min(array.length, Math.floor(n)) <span class="hljs-comment"># OK if n is float</span>
    r = []; <span class="hljs-keyword">while</span> r.length &lt; n
      o = <span class="hljs-property">@oneOf</span>(array); r.push o <span class="hljs-keyword">unless</span> o <span class="hljs-keyword">in</span> r
    r</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>True if item is in array. Binary search if f isnt null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">contains</span>: <span class="hljs-function"><span class="hljs-params">(array, item, f)</span> -&gt;</span> <span class="hljs-property">@indexOf</span>(array, item, f) &gt;= <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Remove an item from an array. Binary search if f isnt null.
Error if item not in array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">removeItem</span>: <span class="hljs-function"><span class="hljs-params">(array, item, f)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> (i = <span class="hljs-property">@indexOf</span> array, item, f) &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> array.splice i, <span class="hljs-number">1</span> 
    <span class="hljs-keyword">else</span> <span class="hljs-property">@error</span> <span class="hljs-string">"removeItem: item not found"</span> <span class="hljs-comment">#; array</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Remove elements in items from an array. Binary search if f isnt null.
Error if an item not in array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">removeItems</span>: <span class="hljs-function"><span class="hljs-params">(array, items, f)</span> -&gt;</span> <span class="hljs-property">@removeItem</span>(array,i,f) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> items; array</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Insert an item in a sorted array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">insertItem</span>: <span class="hljs-function"><span class="hljs-params">(array, item, f)</span> -&gt;</span>
    i = <span class="hljs-property">@sortedIndex</span> array, item, f
    error <span class="hljs-string">"insertItem: item already in array"</span> <span class="hljs-keyword">if</span> array[i] <span class="hljs-keyword">is</span> item
    array.splice i, <span class="hljs-number">0</span>, item</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Randomize the elements of this array.
Clever! See <a href="http://goo.gl/TT2SY">cookbook</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">shuffle</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> array.sort<span class="hljs-function"> -&gt;</span> <span class="hljs-number">0.5</span> - Math.random()</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Return o when f(o) min/max in array. Error if array empty.
If f is a string, return element with max value of that property.
If “valueToo” then return a 2-array of the element and the value;
used for cases where f is costly function.</p>
<pre><code>array = [{<span class="hljs-attribute">x</span>:<span class="hljs-number">1</span>,<span class="hljs-attribute">y</span>:<span class="hljs-number">2</span>}, {<span class="hljs-attribute">x</span>:<span class="hljs-number">3</span>,<span class="hljs-attribute">y</span>:<span class="hljs-number">4</span>}]
<span class="hljs-comment"># returns {x: 1, y: 2} 5</span>
[min, dist2] = minOneOf array, <span class="hljs-function"><span class="hljs-params">((o)-&gt;o.x*o.x+o.y*o.y)</span>, <span class="hljs-title">true</span>
# <span class="hljs-title">returns</span> {<span class="hljs-title">x</span>: 3, <span class="hljs-title">y</span>: 4}
<span class="hljs-title">max</span> = <span class="hljs-title">maxOneOf</span> <span class="hljs-title">array</span>, "<span class="hljs-title">x</span>"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">minOneOf</span>: <span class="hljs-function"><span class="hljs-params">(array, f=<span class="hljs-property">@identity</span>, valueToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-property">@error</span> <span class="hljs-string">"minOneOf: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    r = Infinity; o = <span class="hljs-literal">null</span>; f = <span class="hljs-property">@propFcn</span> f <span class="hljs-keyword">if</span> <span class="hljs-property">@isString</span> f
    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array
      (r = r1; o = a) <span class="hljs-keyword">if</span> (r1=f(a)) &lt; r
    <span class="hljs-keyword">if</span> valueToo <span class="hljs-keyword">then</span> [o, r] <span class="hljs-keyword">else</span> o
  <span class="hljs-attribute">maxOneOf</span>: <span class="hljs-function"><span class="hljs-params">(array, f=<span class="hljs-property">@identity</span>, valueToo=<span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-property">@error</span> <span class="hljs-string">"maxOneOf: empty array"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@empty</span> array
    r = -Infinity; o = <span class="hljs-literal">null</span>; f = <span class="hljs-property">@propFcn</span> f <span class="hljs-keyword">if</span> <span class="hljs-property">@isString</span> f
    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array
      (r = r1; o = a) <span class="hljs-keyword">if</span> (r1=f(a)) &gt; r
    <span class="hljs-keyword">if</span> valueToo <span class="hljs-keyword">then</span> [o, r] <span class="hljs-keyword">else</span> o
  <span class="hljs-attribute">firstOneOf</span>: <span class="hljs-function"><span class="hljs-params">(array, f)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> i <span class="hljs-keyword">for</span> a,i <span class="hljs-keyword">in</span> array <span class="hljs-keyword">when</span> f(a); <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Return histogram of o when f(o) is a numeric value in array.
Histogram interval is bin. Error if array empty.
If f is a string, return histogram of that property.</p>
<p>In examples below, histOf returns [3,1,1,0,0,1]</p>
<pre><code>a = [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">10</span>]
h = histOf a, <span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-params">(i)</span> -&gt;</span> i

b = ({<span class="hljs-attribute">id</span>:i} <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a)
h = histOf b, <span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-params">(o)</span> -&gt;</span> o.id
h = histOf b, <span class="hljs-number">2</span>, <span class="hljs-string">"id"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">histOf</span>: <span class="hljs-function"><span class="hljs-params">(array, bin=<span class="hljs-number">1</span>, f=(i)-&gt;i)</span> -&gt;</span>
    r = []; f = <span class="hljs-property">@propFcn</span> f <span class="hljs-keyword">if</span> <span class="hljs-property">@isString</span> f
    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array
      i = Math.floor f(a)/bin
      r[i] = <span class="hljs-keyword">if</span> (ri=r[i])? <span class="hljs-keyword">then</span> ri+<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    r[i] = <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> val,i <span class="hljs-keyword">in</span> r <span class="hljs-keyword">when</span> <span class="hljs-keyword">not</span> val?
    r</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Mutator. Sort array of objects in place by the function f.
If f is string, f returns property of object.
Returns array.
Clone first if you want to preserve the original array.</p>
<pre><code>array = [{<span class="hljs-attribute">i</span>:<span class="hljs-number">1</span>},{<span class="hljs-attribute">i</span>:<span class="hljs-number">5</span>},{<span class="hljs-attribute">i</span>:-<span class="hljs-number">1</span>},{<span class="hljs-attribute">i</span>:<span class="hljs-number">2</span>},{<span class="hljs-attribute">i</span>:<span class="hljs-number">2</span>}]
sortBy array, <span class="hljs-string">"i"</span>
<span class="hljs-comment"># array now is [{i:-1},{i:1},{i:2},{i:2},{i:5}]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sortBy</span>: <span class="hljs-function"><span class="hljs-params">(array, f)</span> -&gt;</span> 
   f = <span class="hljs-property">@propFcn</span> f <span class="hljs-keyword">if</span> <span class="hljs-property">@isString</span> f <span class="hljs-comment"># use item[f] if f is string</span>
   array.sort <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> f(a) - f(b)</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Numeric sort, default to ascending. Mutator, see clone above.
Works with TypedArrays too</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sortNums</span>: <span class="hljs-function"><span class="hljs-params">(array, ascending=<span class="hljs-literal">true</span>)</span> -&gt;</span>
    f = <span class="hljs-keyword">if</span> ascending <span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> a-b <span class="hljs-keyword">else</span> <span class="hljs-function"><span class="hljs-params">(a,b)</span> -&gt;</span> b-a
    <span class="hljs-keyword">if</span> array.sort? <span class="hljs-keyword">then</span> array.sort(f) <span class="hljs-keyword">else</span> Array.prototype.sort.call(array, f)</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Mutator. Removes adjacent dups, by reference, in place from sorted array.
Note “by reference” means litteraly same object, not copy. Returns array.
Clone first if you want to preserve the original array.</p>
<pre><code>ids = ({<span class="hljs-attribute">id</span>:i} <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.10</span>])
a = (ids[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">10</span>])
<span class="hljs-comment"># a is [{id:1},{id:3},{id:4},{id:1},{id:1},{id:10}]</span>
b = clone a
sortBy b, <span class="hljs-string">"id"</span>
<span class="hljs-comment"># b is [{id:1},{id:1},{id:1},{id:3},{id:4},{id:10}]</span>
uniq b
<span class="hljs-comment"># b now is [{id:1},{id:3},{id:4},{id:10}]</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">uniq</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> array <span class="hljs-keyword">if</span> array.length &lt; <span class="hljs-number">2</span> <span class="hljs-comment"># return if empty or singlton</span>
    array.splice i,<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [array.length-<span class="hljs-number">1.</span><span class="hljs-number">.1</span>] <span class="hljs-keyword">by</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">when</span> array[i-<span class="hljs-number">1</span>] <span class="hljs-keyword">is</span> array[i]
    array</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Return a new array composed of the rows of a matrix. I.e. convert</p>
<pre><code>[[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]] to [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">flatten</span>: <span class="hljs-function"><span class="hljs-params">(matrix)</span> -&gt;</span> matrix.reduce<span class="hljs-function"><span class="hljs-params">( (a,b) -&gt; a.concat b )</span>
  
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Return array of property values of given array of objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aProp</span>: <span class="hljs-function"><span class="hljs-params">(array, propOrFn)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> propOrFn <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">then</span> propOrFn(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array
    <span class="hljs-keyword">else</span> a[propOrFn] <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Return hybred array with object named properties. Good for returning multiple
values from a function, and destructured assignment.</p>
<pre><code>a = aToObj [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], [<span class="hljs-string">"one"</span>, <span class="hljs-string">"two"</span>, <span class="hljs-string">"three"</span>, <span class="hljs-string">"four"</span>]
a = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], a.one = <span class="hljs-number">1</span>, .. a.four = <span class="hljs-number">4</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aToObj</span>: <span class="hljs-function"><span class="hljs-params">(array, names)</span> -&gt;</span> array[n] = array[i] <span class="hljs-keyword">for</span> n,i <span class="hljs-keyword">in</span> names; array</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Return scalar max/min/sum/avg of numeric array
Iterate rather than reduce: work with typed arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aMax</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> v=array[<span class="hljs-number">0</span>]; v=Math.max v,a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array; v
  <span class="hljs-attribute">aMin</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> v=array[<span class="hljs-number">0</span>]; v=Math.min v,a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array; v
  <span class="hljs-attribute">aSum</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> v=<span class="hljs-number">0</span>; v += a <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> array; v
  <span class="hljs-attribute">aAvg</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> <span class="hljs-property">@aSum</span>(array)/array.length
  <span class="hljs-attribute">aMid</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> 
    array = <span class="hljs-keyword">if</span> array.sort? <span class="hljs-keyword">then</span> <span class="hljs-property">@clone</span> array <span class="hljs-keyword">else</span> <span class="hljs-property">@typedToJS</span> array
    <span class="hljs-property">@sortNums</span> array
    array[Math.floor(array.length/<span class="hljs-number">2</span>)]

  <span class="hljs-attribute">aNaNs</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> (i <span class="hljs-keyword">for</span> v,i <span class="hljs-keyword">in</span> array <span class="hljs-keyword">when</span> isNaN v)</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Return array composed of f pairwise on both arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">aPairwise</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2, f)</span> -&gt;</span> v=<span class="hljs-number">0</span>; f(v,a2[i]) <span class="hljs-keyword">for</span> v,i <span class="hljs-keyword">in</span> a1 
  <span class="hljs-attribute">aPairSum</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2)</span> -&gt;</span> <span class="hljs-property">@aPairwise</span> a1, a2, <span class="hljs-function"><span class="hljs-params">(a,b)</span>-&gt;</span>a+b
  <span class="hljs-attribute">aPairDif</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2)</span> -&gt;</span> <span class="hljs-property">@aPairwise</span> a1, a2, <span class="hljs-function"><span class="hljs-params">(a,b)</span>-&gt;</span>a-b
  <span class="hljs-attribute">aPairMul</span>: <span class="hljs-function"><span class="hljs-params">(a1, a2)</span> -&gt;</span> <span class="hljs-property">@aPairwise</span> a1, a2, <span class="hljs-function"><span class="hljs-params">(a,b)</span>-&gt;</span>a*b</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Return a JS array given a TypedArray.
To create TypedArray from JS array: new Uint8Array(jsa) etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">typedToJS</span>: <span class="hljs-function"><span class="hljs-params">(typedArray)</span> -&gt;</span> (i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> typedArray)</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Return a linear interpolation between lo and hi.
Scale is in [0-1], and the result is in [lo,hi]
<a href="http://goo.gl/QrzMc">Why the name <code>lerp</code>?</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">lerp</span>: <span class="hljs-function"><span class="hljs-params">(lo, hi, scale)</span> -&gt;</span> lo + (hi-lo)*scale <span class="hljs-comment"># @clamp(scale, 0, 1)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Return point interpolated between two points.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">lerp2</span>: <span class="hljs-function"><span class="hljs-params">(x0, y0, x1, y1, scale)</span> -&gt;</span> [<span class="hljs-property">@lerp</span>(x0,x1,scale), <span class="hljs-property">@lerp</span>(y0,y1,scale)]</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Return an array with values in [lo,hi], defaults to [0,1].
Note: to have a half-open interval, [lo,hi), try hi=hi-.00009</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">normalize</span>: <span class="hljs-function"><span class="hljs-params">(array, lo = <span class="hljs-number">0</span>, hi = <span class="hljs-number">1</span>)</span> -&gt;</span>
    min = <span class="hljs-property">@aMin</span> array; max = <span class="hljs-property">@aMax</span> array; scale = <span class="hljs-number">1</span>/(max-min)
    (<span class="hljs-property">@lerp</span>(lo, hi, scale*(num-min)) <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> array)</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Return a Uint8ClampedArray, normalized to [.5,255.5] then round/clamp to [0,255]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">normalize8</span>: <span class="hljs-function"><span class="hljs-params">(array)</span> -&gt;</span> <span class="hljs-keyword">new</span> Uint8ClampedArray <span class="hljs-property">@normalize</span>(array,-<span class="hljs-number">.5</span>,<span class="hljs-number">255.5</span>)
  <span class="hljs-attribute">normalizeInt</span>: <span class="hljs-function"><span class="hljs-params">(array, lo, hi)</span> -&gt;</span> (Math.round i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-property">@normalize</span> array, lo, hi) <span class="hljs-comment"># clamp?</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Return array index of item, or index for item if array to remain sorted.
f is used to return an integer for sorting, primarily for object properties.
If f is a string, it is the object property to sort by.
Adapted from underscore’s _.sortedIndex.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">sortedIndex</span>: <span class="hljs-function"><span class="hljs-params">(array, item, f=(o)-&gt;o)</span> -&gt;</span> <span class="hljs-comment"># update to _.sortedIndex someday</span>
    f = <span class="hljs-property">@propFcn</span> f <span class="hljs-keyword">if</span> <span class="hljs-property">@isString</span> f <span class="hljs-comment"># use item[f] if f is string</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Why not array.length - 1? Because we can insert 1 after end of array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    value = f(item); low = <span class="hljs-number">0</span>; high = array.length
    <span class="hljs-keyword">while</span> low &lt; high
      mid = (low + high) &gt;&gt;&gt; <span class="hljs-number">1</span> <span class="hljs-comment"># floor (low+high)/2</span>
      <span class="hljs-keyword">if</span> f(array[mid]) &lt; value <span class="hljs-keyword">then</span> low = mid + <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> high = mid
    low</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Return argument unchanged; for primitive arrays or objs sorted by reference</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">identity</span>: <span class="hljs-function"><span class="hljs-params">(o)</span> -&gt;</span> o</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Return a function that returns an object’s property.  Property in fcn closure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">propFcn</span>: <span class="hljs-function"><span class="hljs-params">(prop)</span> -&gt;</span> <span class="hljs-function"><span class="hljs-params">(o)</span>-&gt;</span>o[prop]</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Return index of value in array or -1 if not found.
If no property given, use Array.indexOf.
If property given, use binary search.
Property can be string or function. If property is “”, use identity default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">indexOf</span>: <span class="hljs-function"><span class="hljs-params">(array, item, property)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> property?
      i = <span class="hljs-property">@sortedIndex</span> array, item, <span class="hljs-keyword">if</span> property <span class="hljs-keyword">is</span> <span class="hljs-string">""</span> <span class="hljs-keyword">then</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> property
      <span class="hljs-keyword">if</span> array[i] <span class="hljs-keyword">is</span> item <span class="hljs-keyword">then</span> i <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span> array.indexOf item</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <h3 id="topology-operations">Topology Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Return angle in [-pi,pi] radians from x1,y1 to x2,y2
<a href="http://goo.gl/JS8DF">See: Math.atan2</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">radsToward</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2)</span> -&gt;</span> Math.atan2 y2-y1, x2-x1</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Return true if x2,y2 is in cone radians around heading radians from x1,x2
and within distance radius from x1,x2.
I.e. is p2 in cone/heading/radius from p1?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inCone</span>: <span class="hljs-function"><span class="hljs-params">(heading, cone, radius, x1, y1, x2, y2)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> radius &lt; <span class="hljs-property">@distance</span> x1, y1, x2, y2 <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    angle12 = <span class="hljs-property">@radsToward</span> x1, y1, x2, y2 <span class="hljs-comment"># angle from 1 to 2</span>
    cone/<span class="hljs-number">2</span> &gt;=Math.abs <span class="hljs-property">@subtractRads</span>(heading, angle12)</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Return the Euclidean distance and distance squared between x1,y1, x2,y2.
The squared distance is used for comparisons to avoid the Math.sqrt fcn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">distance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2)</span> -&gt;</span> dx = x1-x2; dy = y1-y2; Math.sqrt dx*dx + dy*dy
  <span class="hljs-attribute">sqDistance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2)</span> -&gt;</span> dx = x1-x2; dy = y1-y2; dx*dx + dy*dy</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Convert polar r,theta to cartesian x,y.
Default to 0,0 origin, optional x,y origin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">polarToXY</span>: <span class="hljs-function"><span class="hljs-params">(r, theta, x=<span class="hljs-number">0</span>, y=<span class="hljs-number">0</span>)</span> -&gt;</span> [x+r*Math.cos(theta), y+r*Math.sin(theta)]</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Return the <a href="http://goo.gl/PgJ5N">torus distance</a> and distance squared
between two points A(x1,y1) and B(x2,y2):</p>
<pre><code>dx = |x2-x1|; dy = |y2-y1|
d=sqrt(min(dx, W-dx)^<span class="hljs-number">2</span> + min(dy, H-dy)^<span class="hljs-number">2</span>)
</code></pre><p>Torus note: ABMs often use a Torus topology where the right and left edges
fold to meet,and similarly for the top/bottom.
For points, this is easily handled with the mod function .. insuring the
point is within the rectangle modulo W &amp; H.</p>
<p>The relationship <em>between</em> points is more difficult.  The relationship between
A and B must also include the towards-reflections around A, thus 4 points.</p>
<pre><code>     |               |
     |      W        |
-----+---------------+-----
 B1  |           B   |
     |               |  H
     |               |
     |  A            |
-----+---------------+-----
 B3  |           B2  |
     |               |
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusDistance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span> 
    Math.sqrt <span class="hljs-property">@torusSqDistance</span> x1, y1, x2, y2, w, h
  <span class="hljs-attribute">torusSqDistance</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    dx = Math.abs x2-x1; dy = Math.abs y2-y1
    dxMin = Math.min dx, w-dx; dyMin = Math.min dy, h-dy
    dxMin*dxMin + dyMin*dyMin</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Return true if closest path between x1,y1 &amp; x2,y2 wraps around the torus.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusWraps</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    dx = Math.abs x2-x1; dy = Math.abs y2-y1
    dx &gt; w-dx <span class="hljs-keyword">or</span> dy &gt; h-dy</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Return 4 torus point reflections of x2,y2 around x1,y1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torus4Pts</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    x2r = <span class="hljs-keyword">if</span> x2&lt;x1 <span class="hljs-keyword">then</span> x2+w <span class="hljs-keyword">else</span> x2-w
    y2r = <span class="hljs-keyword">if</span> y2&lt;y1 <span class="hljs-keyword">then</span> y2+h <span class="hljs-keyword">else</span> y2-h
    [ [x2,y2], [x2r,y2], [x2,y2r], [x2r,y2r] ]</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Return closest of 4 torus pts from A to B</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusPt</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span>
    x2r = <span class="hljs-keyword">if</span> x2&lt;x1 <span class="hljs-keyword">then</span> x2+w <span class="hljs-keyword">else</span> x2-w
    y2r = <span class="hljs-keyword">if</span> y2&lt;y1 <span class="hljs-keyword">then</span> y2+h <span class="hljs-keyword">else</span> y2-h
    x = <span class="hljs-keyword">if</span> Math.abs(x2r-x1) &lt; Math.abs(x2-x1) <span class="hljs-keyword">then</span> x2r <span class="hljs-keyword">else</span> x2
    y = <span class="hljs-keyword">if</span> Math.abs(y2r-y1) &lt; Math.abs(y2-y1) <span class="hljs-keyword">then</span> y2r <span class="hljs-keyword">else</span> y2
    [x,y]</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Return the angle from x1,y1 to x2.y2 on torus using shortest reflection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">torusRadsToward</span>: <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, w, h)</span> -&gt;</span> 
    [x2,y2] = <span class="hljs-property">@torusPt</span> x1, y1, x2, y2, w, h
    <span class="hljs-property">@radsToward</span> x1, y1, x2, y2</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Return true if x2,y2 is in cone radians around heading radians from x1,x2
and within distance radius from x1,x2 considering all torus reflections.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">inTorusCone</span>: <span class="hljs-function"><span class="hljs-params">(heading, cone, radius, x1, y1, x2, y2, w, h)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-property">@torus4Pts</span> x1, y1, x2, y2, w, h
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@inCone</span> heading, cone, radius, x1, y1, p[<span class="hljs-number">0</span>], p[<span class="hljs-number">1</span>]
    <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <h3 id="file-i-o">File I/O</h3>

            </div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Cache of file names used by file imports below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fileIndex</span>: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Import an image, executing (async) optional function f(img) on completion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">importImage</span>: <span class="hljs-function"><span class="hljs-params">(name, f = -&gt;)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> (img=<span class="hljs-property">@fileIndex</span>[name])? <span class="hljs-comment"># wtf? or ((img=name).width and img.height)</span>
      f(img) <span class="hljs-comment">#if img.isDone</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@fileIndex</span>[name] = img = <span class="hljs-keyword">new</span> Image()
      img.isDone = <span class="hljs-literal">false</span>
      img.crossOrigin = <span class="hljs-string">"Anonymous"</span>
      img.<span class="hljs-function"><span class="hljs-title">onload</span> = -&gt;</span> f(img); img.isDone = <span class="hljs-literal">true</span>
      img.src = name
    img</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Use XMLHttpRequest to fetch data of several types. Data Types: text,
arraybuffer, blob, json, document, <a href="http://goo.gl/y3r3h">See specification</a>.
method is “GET” or “POST”. f is function to call onload, default to no-op.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">xhrLoadFile</span>: <span class="hljs-function"><span class="hljs-params">(name, method=<span class="hljs-string">"GET"</span>, type=<span class="hljs-string">"text"</span>, f = -&gt;)</span> -&gt;</span> <span class="hljs-comment"># AJAX async request</span>
    <span class="hljs-keyword">if</span> (xhr=<span class="hljs-property">@fileIndex</span>[name])?
      f(xhr.response)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@fileIndex</span>[name] = xhr = <span class="hljs-keyword">new</span> XMLHttpRequest()
      xhr.isDone = <span class="hljs-literal">false</span>
      xhr.open method, name <span class="hljs-comment"># POST mainly for security and large files</span>
      xhr.responseType = type
      xhr.<span class="hljs-function"><span class="hljs-title">onload</span> = -&gt;</span> f(xhr.response); xhr.isDone = <span class="hljs-literal">true</span>
      xhr.send()
    xhr</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Return true if all files are loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">filesLoaded</span>: <span class="hljs-function"><span class="hljs-params">(files = <span class="hljs-property">@fileIndex</span>)</span> -&gt;</span>
    array = (v.isDone <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> (<span class="hljs-property">@ownValues</span> files))
    array.reduce <span class="hljs-function"><span class="hljs-params">((a,b)-&gt;a <span class="hljs-keyword">and</span> b)</span>, <span class="hljs-title">true</span>
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Wait for files to be loaded before executing callback f</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">waitOnFiles</span>: <span class="hljs-function"><span class="hljs-params">(f, files = <span class="hljs-property">@fileIndex</span>)</span> -&gt;</span> <span class="hljs-property">@waitOn</span> (<span class="hljs-function">=&gt;</span> <span class="hljs-property">@filesLoaded</span> files), f</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Wait for function done() to return true before calling callback f</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">waitOn</span>: <span class="hljs-function"><span class="hljs-params">(done, f)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> done() <span class="hljs-keyword">then</span> f() <span class="hljs-keyword">else</span> setTimeout (<span class="hljs-function">=&gt;</span> <span class="hljs-property">@waitOn</span>(done, f)), <span class="hljs-number">1000</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <h3 id="image-data-operations">Image Data Operations</h3>
<p>Make a copy of an image.
Note: new image will have the naturalWidth/Height of input img.
Should be sync</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cloneImage</span>: <span class="hljs-function"><span class="hljs-params">(img)</span> -&gt;</span> (i=<span class="hljs-keyword">new</span> Image()).src = img.src; i</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Create a data array from an image’s imageData
img may be a canvas.
The function f = f(imageData, rgbIndex) -&gt; number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">imageToData</span>: <span class="hljs-function"><span class="hljs-params">(img, f=<span class="hljs-property">@pixelByte</span>(<span class="hljs-number">0</span>), arrayType=Uint8ClampedArray)</span> -&gt;</span>
    <span class="hljs-property">@imageRowsToData</span> img, img.height, f, arrayType
  <span class="hljs-attribute">imageRowsToData</span>: <span class="hljs-function"><span class="hljs-params">(img, rowsPerSlice, f=<span class="hljs-property">@pixelByte</span>(<span class="hljs-number">0</span>), arrayType=Uint8ClampedArray)</span> -&gt;</span>
    rowsDone = <span class="hljs-number">0</span>; data = <span class="hljs-keyword">new</span> arrayType img.width*img.height
    <span class="hljs-keyword">while</span> rowsDone &lt; img.height
      rows = Math.min img.height - rowsDone, rowsPerSlice
      ctx = <span class="hljs-property">@imageSliceToCtx</span> img, <span class="hljs-number">0</span>, rowsDone, img.width, rows <span class="hljs-comment"># REMIND: pass ctx</span>
      idata = <span class="hljs-property">@ctxToImageData</span>(ctx).data
      dataStart = rowsDone*img.width
      data[dataStart+i] = f(idata,<span class="hljs-number">4</span>*i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..idata.length/<span class="hljs-number">4</span>] <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>
      rowsDone += rows
    data</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Two utilities for Image data extraction.
They return a fcn in a closure which “sees” the args and variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">pixelBytesToInt</span>: <span class="hljs-function"><span class="hljs-params">(a)</span> -&gt;</span>
    ImageByteFmts = [[<span class="hljs-number">2</span>],[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],[<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]]
    a=ImageByteFmts[a-<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> a <span class="hljs-keyword">is</span> <span class="hljs-string">"number"</span>
    <span class="hljs-function"><span class="hljs-params">(id,i)</span>-&gt;</span>val = <span class="hljs-number">0</span>; val = val*<span class="hljs-number">256</span> + id[i+j] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> a; val
  <span class="hljs-attribute">pixelByte</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span> <span class="hljs-function"><span class="hljs-params">(id,i)</span>-&gt;</span>id[i+n]</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <h3 id="canvas-context-operations">Canvas/Context Operations</h3>

            </div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Create a new canvas of given width/height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">createCanvas</span>: <span class="hljs-function"><span class="hljs-params">(width, height)</span> -&gt;</span>
    can = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'canvas'</span>
    can.width = width; can.height = height
    can</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>As above, but returing the context object.
Note ctx.canvas is the canvas for the ctx, and can be use as an image.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">createCtx</span>: <span class="hljs-function"><span class="hljs-params">(width, height, ctxType=<span class="hljs-string">"2d"</span>)</span> -&gt;</span>
    can = <span class="hljs-property">@createCanvas</span> width, height
    <span class="hljs-keyword">if</span> ctxType <span class="hljs-keyword">is</span> <span class="hljs-string">"2d"</span>
    <span class="hljs-keyword">then</span> can.getContext <span class="hljs-string">"2d"</span> 
    <span class="hljs-keyword">else</span> can.getContext(<span class="hljs-string">"webgl"</span>) ? can.getContext(<span class="hljs-string">"experimental-webgl"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Return a “layer” 2D/3D rendering context within the specified HTML <code>&lt;div&gt;</code>,
with the given width/height positioned absolutely at top/left within the div,
and with the z-index of z.</p>
<p>The z level gives us the capability of buildng a “stack” of coordinated canvases.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">createLayer</span>: <span class="hljs-function"><span class="hljs-params">(div, width, height, z, ctx = <span class="hljs-string">"2d"</span>)</span> -&gt;</span> <span class="hljs-comment"># a canvas ctx object</span>
    <span class="hljs-keyword">if</span> ctx <span class="hljs-keyword">is</span> <span class="hljs-string">"img"</span> 
    <span class="hljs-keyword">then</span> element = ctx = <span class="hljs-keyword">new</span> Image(); ctx.width = width; ctx.height=height
    <span class="hljs-keyword">else</span> element = (ctx=<span class="hljs-property">@createCtx</span>(width, height, ctx)).canvas
    <span class="hljs-property">@insertLayer</span> div, element, width, height, z
    ctx
  <span class="hljs-attribute">insertLayer</span>: <span class="hljs-function"><span class="hljs-params">(div, element, w, h, z)</span> -&gt;</span>
    element.setAttribute <span class="hljs-string">'style'</span>, <span class="hljs-comment"># Note: this erases existing style, el.style.position doesnt</span>
    <span class="hljs-string">"position:absolute;top:0;left:0;width:<span class="hljs-subst">#{w}</span>;height:<span class="hljs-subst">#{h}</span>;z-index:<span class="hljs-subst">#{z}</span>"</span>
    div.appendChild(element)

  <span class="hljs-attribute">setCtxSmoothing</span>: <span class="hljs-function"><span class="hljs-params">(ctx, smoothing)</span> -&gt;</span>
    ctx.imageSmoothingEnabled = smoothing
    ctx.mozImageSmoothingEnabled = smoothing
    ctx.oImageSmoothingEnabled = smoothing
    ctx.webkitImageSmoothingEnabled = smoothing</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Install identity transform.  Call ctx.restore() to revert to previous transform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">setIdentity</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    ctx.save() <span class="hljs-comment"># revert to native 2D transform</span>
    ctx.setTransform <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Clear the 2D/3D layer to be transparent. Note this <a href="http://goo.gl/qekXS">discussion</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clearCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> ctx.save? <span class="hljs-comment"># test for 2D ctx</span>
      <span class="hljs-property">@setIdentity</span> ctx <span class="hljs-comment"># ctx.canvas.width = ctx.canvas.width not used so as to preserve patch coords</span>
      ctx.clearRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height
      ctx.restore()
    <span class="hljs-keyword">else</span> <span class="hljs-comment"># 3D</span>
      ctx.clearColor <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> <span class="hljs-comment"># transparent!</span>
      ctx.clear ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Fill the 2D/3D layer with the given color</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fillCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx, color)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> ctx.fillStyle? <span class="hljs-comment"># test for 2D ctx</span>
      <span class="hljs-property">@setIdentity</span> ctx
      ctx.fillStyle = <span class="hljs-property">@colorStr</span>(color)
      ctx.fillRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height
      ctx.restore()
    <span class="hljs-keyword">else</span> <span class="hljs-comment"># 3D</span>
      ctx.clearColor color..., <span class="hljs-number">1</span> <span class="hljs-comment"># alpha = 1 unless color is rgba</span>
      ctx.clear ctx.COLOR_BUFFER_BIT | ctx.DEPTH_BUFFER_BIT</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Draw string of the given color at the xy location, in ctx pixel coords.
Use setIdentity .. reset if a transform is being used by caller.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxDrawText</span>: <span class="hljs-function"><span class="hljs-params">(ctx, string, x, y, color = [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>], setIdentity = <span class="hljs-literal">true</span>)</span> -&gt;</span>
    <span class="hljs-property">@setIdentity</span>(ctx) <span class="hljs-keyword">if</span> setIdentity
    ctx.fillStyle = <span class="hljs-property">@colorStr</span> color;  ctx.fillText(string, x, y)
    ctx.restore() <span class="hljs-keyword">if</span> setIdentity</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Set the element text align and baseline drawing parameters</p>
<ul>
<li>font is a HTML/CSS string like: “9px sans-serif”</li>
<li>align is left right center start end</li>
<li>baseline is top hanging middle alphabetic ideographic bottom</li>
</ul>
<p>See <a href="http://goo.gl/AvEAq">reference</a> for details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxTextParams</span>: <span class="hljs-function"><span class="hljs-params">(ctx, font, align = <span class="hljs-string">"center"</span>, baseline = <span class="hljs-string">"middle"</span>)</span> -&gt;</span> 
    ctx.font = font; ctx.textAlign = align; ctx.textBaseline = baseline
  <span class="hljs-attribute">elementTextParams</span>: <span class="hljs-function"><span class="hljs-params">(e, font, align = <span class="hljs-string">"center"</span>, baseline = <span class="hljs-string">"middle"</span>)</span> -&gt;</span> 
    e = e.canvas <span class="hljs-keyword">if</span> e.canvas?
    e.style.font = font; e.style.textAlign = align; e.style.textBaseline = baseline</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Convert an image to a context. ctx.canvas gives the created canvas.
If w, h provided, scale to that size. img may be a canvas
Note: to convert a ctx to an “image” (drawImage) use ctx.canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">imageToCtx</span>: <span class="hljs-function"><span class="hljs-params">(img, w, h)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> w? <span class="hljs-keyword">and</span> h?
      ctx = <span class="hljs-property">@createCtx</span> w, h
      ctx.drawImage img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h
    <span class="hljs-keyword">else</span>
      ctx = <span class="hljs-property">@createCtx</span> img.width, img.height
      ctx.drawImage img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    ctx
  <span class="hljs-attribute">imageSliceToCtx</span>: <span class="hljs-function"><span class="hljs-params">(img, sx, sy, sw, sh, ctx)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> ctx?
    <span class="hljs-keyword">then</span> ctx.canvas.width = sw; ctx.canvas.height = sh
    <span class="hljs-keyword">else</span> ctx = <span class="hljs-property">@createCtx</span> sw, sh
    ctx.drawImage img, sx, sy, sw, sh, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sw, sh
    ctx
  <span class="hljs-attribute">imageToCtxDownStepped</span>: <span class="hljs-function"><span class="hljs-params">(img, tw, th)</span> -&gt;</span> <span class="hljs-comment"># http://goo.gl/UnLJSZ</span>
    ctx1 = u.createCtx tw, th
    w = img.width; h = img.height; <span class="hljs-function"><span class="hljs-title">ihalf</span> = <span class="hljs-params">(n)</span> -&gt;</span> Math.ceil n/<span class="hljs-number">2</span>
    steps = Math.ceil(u.log2( <span class="hljs-keyword">if</span> (w/tw)&gt;(h/th) <span class="hljs-keyword">then</span> (w/tw) <span class="hljs-keyword">else</span> (h/th)) )
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"steps"</span>, steps
    <span class="hljs-keyword">if</span> steps &lt;= <span class="hljs-number">1</span>
      ctx1.drawImage img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, tw, th
    <span class="hljs-keyword">else</span>
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">"img w/h"</span>, w, h, <span class="hljs-string">"-&gt;"</span>, ihalf(w), ihalf(h)
      ctx = u.createCtx w = ihalf(w), h = ihalf(h); can = ctx.canvas
      ctx.drawImage img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h
      <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> [steps..<span class="hljs-number">.2</span>] <span class="hljs-comment"># 2 not 1 due to initial halving above</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"can w/h"</span>, w, h, <span class="hljs-string">"-&gt;"</span>, ihalf(w), ihalf(h)
        ctx.drawImage can, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w = ihalf(w), h = ihalf(h)
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">"target w/h"</span>, w, h, <span class="hljs-string">"-&gt;"</span>, tw, th
      ctx1.drawImage can, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, tw, th
    ctx1</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Convert a canvas to an image, executing fcn f on completion.
Generally can skip callback but see <a href="http://goo.gl/kIk2U">stackoverflow</a>
Note: uses toDataURL thus possible cross origin problems.
Fix: use ctx.canvas for programatic imaging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxToDataUrl</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span> ctx.canvas.toDataURL <span class="hljs-string">"image/png"</span>
  <span class="hljs-attribute">ctxToDataUrlImage</span>: <span class="hljs-function"><span class="hljs-params">(ctx, f)</span> -&gt;</span>
    img = <span class="hljs-keyword">new</span> Image()
    (img.<span class="hljs-function"><span class="hljs-title">onload</span> = -&gt;</span> f(img)) <span class="hljs-keyword">if</span> f?
    img.src = ctx.canvas.toDataURL <span class="hljs-string">"image/png"</span>
    img</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Convert a ctx to an imageData object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">ctxToImageData</span>: <span class="hljs-function"><span class="hljs-params">(ctx)</span> -&gt;</span>
    ctx.getImageData <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ctx.canvas.width, ctx.canvas.height</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Canvas versions of above
canvasToImage: (canvas) -&gt; ctxToImage(canvas.getContext “2d”)
canvasToImageData: (canvas) -&gt; ctxToImageData(canvas.getContext “2d”)
imageToCanvas: (image) -&gt; imageToCtx(image).canvas</p>

            </div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Draw an image centered at x, y w/ image size dx, dy.
See <a href="http://goo.gl/VUlhY">this tutorial</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">drawCenteredImage</span>: <span class="hljs-function"><span class="hljs-params">(ctx, img, rad, x, y, dx, dy)</span> -&gt;</span> <span class="hljs-comment"># presume save/restore surrounds this</span>
    ctx.translate x, y <span class="hljs-comment"># translate to center</span>
    ctx.rotate rad
    ctx.drawImage img, -dx/<span class="hljs-number">2</span>, -dy/<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Duplicate a ctx’s image.  Returns the new ctx, use ctx.canvas for canvas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copyCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx0)</span> -&gt;</span>
    ctx = <span class="hljs-property">@createCtx</span> ctx0.canvas.width, ctx0.canvas.height
    ctx.drawImage ctx0.canvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Resize a ctx/canvas and preserve data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">resizeCtx</span>: <span class="hljs-function"><span class="hljs-params">(ctx, width, height, scale = <span class="hljs-literal">false</span>)</span> -&gt;</span> <span class="hljs-comment"># http://goo.gl/Tp90B</span>
    copy = <span class="hljs-property">@copyCtx</span> ctx
    ctx.canvas.width = width; ctx.canvas.height = height
    ctx.drawImage copy.canvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
