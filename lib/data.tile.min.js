(function(){ABM.TileDataSet=function(){function t(t,i,e,o){this.tileSize=e||256,this.tiles={},this.width=t,this.height=i,this.model=o,this.zoom=0,this.origin={x:0,y:0}}return t.prototype=new ABM.DataSet,t.prototype.addTile=function(t,i){var e=[t.z,t.x,t.y].join("/");this.tiles[e]=i},t.prototype.getTileContainingPoint=function(t,i){var e=this.zoom,o={x:this.origin.x+t,y:this.origin.y+i},l=Math.floor(o.x/this.tileSize),s=Math.floor(o.y/this.tileSize),a=this.tiles[e+"/"+l+"/"+s];return a||console.log("ERR: tried to sample tile",e,l,s,"but it doesn't exist."),a},t.prototype.importTileData=function(){this.data=new Array(this.width*this.height);for(var t=0;t<this.data.length;t++)this.data[t]=0;for(var i=this.origin,e={x:i.x+this.width,y:i.y+this.height},o={x:Math.floor(i.x/this.tileSize),y:Math.floor(i.y/this.tileSize)},l={left:i.x%this.tileSize,top:i.y%this.tileSize,right:e.x%this.tileSize,bottom:e.y%this.tileSize},s=Math.floor(this.width/this.tileSize),a=Math.floor(this.height/this.tileSize),h=0;s>=h;h++)for(var n=0;a>=n;n++){var r=this.getTileContainingPoint(h*this.tileSize,n*this.tileSize);if(r){var d=r.getImageData(0,0,this.tileSize,this.tileSize),f={left:(o.x+h)*this.tileSize,top:(o.y+n)*this.tileSize},y={x:0,y:0},p={x:this.tileSize-1,y:this.tileSize-1};0==h&&(y.x=l.left),(h+1)*this.tileSize>this.width&&(p.x=l.right),0==n&&(y.y=l.top),(n+1)*this.tileSize>this.height&&(p.y=l.bottom);for(var g=y.x;g<=p.x;g++)for(var u=y.y;u<=p.y;u++){var z={x:g+f.left-i.x,y:u+f.top-i.y},x=this.toIndex(z.x,z.y),c=4*(u*this.tileSize+g);this.data[x]=this.parseTileData([d.data[c],d.data[c+1],d.data[c+2],d.data[c+3]])}}}},t.prototype.parseTileData=function(t){return t},t.prototype.bindToLeaflet=function(t,i,e){function o(t){var i=/.*\/(\d+)\/(\d+)\/(\d+)\.png$/,e=i.exec(t);return e&&{z:e[1],x:e[2],y:e[3]}}if(this.leafletMap=t,this.leafletLayer=i,!e){this.embedLeaflet();var l=this.leafletMap.getSize();this.width=l.x,this.height=l.y}this.tileSize=i._getTileSize(),this.origin=this.leafletMap.getPixelBounds().min,this.zoom=t.getZoom(),i.on("tileload",function(t){var i=o(t.url);if(!i)return void console.log("err: couldn't parse tile coordinates for",t.url);var e=ABM.util.imageToCtx(t.tile,this.tileSize,this.tileSize);this.addTile(i,e)}.bind(this)),t.on("zoomstart",function(){this.tiles={}}.bind(this)),t.on("moveend",function(){this.origin=this.leafletMap.getPixelBounds().min}.bind(this)),t.on("zoomend",function(){this.zoom=this.leafletMap.getZoom()}.bind(this)),this.on=function(t,i){var e=this.leafletLayer;e&&e.on(t,i)},this.off=function(t,i){var e=this.leafletLayer;e&&e.off(t,i)};var s=!0,a=!1;i.on("loading",function(){a=!1}),t.on("movestart",function(){s=!1}),i.on("load",function(){a=!0,s&&this.leafletLayer.fire("tilesready")}.bind(this)),t.on("moveend",function(){s=!0,a&&this.leafletLayer.fire("tilesready")}.bind(this))},t.prototype.embedLeaflet=function(){return this.model.div?(ABM.util.insertLayer(this.model.div,this.leafletMap.getContainer(),this.model.world.pxWidth+"px",this.model.world.pxHeight+"px",15),void this.leafletMap.invalidateSize()):void console.log("ERR: Tried to embed leaflet map into a headless model, or before model div was initialized.")},t}()}).call(this),L.CrossOriginTileLayer=L.TileLayer.extend({_createTile:function(){var t=L.TileLayer.prototype._createTile.apply(this);return t.crossOrigin="",t}}),L.crossOriginTileLayer=function(t,i){return new L.CrossOriginTileLayer(t,i)};